"use client";
import { useEffect, useRef } from "react";
import Script from "next/script";

export default function Home() {
  return (
    <>
      <div dangerouslySetInnerHTML={{ __html: "<div id=\"toast-container\" class=\"fixed top-4 right-4 z-50 flex flex-col gap-2 max-w-sm\"></div>\r\n\r\n    <!-- Network Status Indicator -->\r\n    <div id=\"network-status\"\r\n        class=\"fixed top-2 left-2 z-40 flex items-center gap-1.5 px-2 py-1 rounded-full bg-gray-900/80 backdrop-blur border border-gray-700\">\r\n        <div id=\"network-indicator\" class=\"w-2 h-2 rounded-full bg-green-500\"></div>\r\n        <span id=\"network-text\" class=\"text-xs text-gray-400\">Online</span>\r\n    </div>\r\n\r\n    <div id=\"loading-overlay\"\r\n        class=\"fixed inset-0 bg-black/95 backdrop-blur-md z-50 flex items-center justify-center hidden\">\r\n        <div class=\"text-center\">\r\n            <!-- Animated rings -->\r\n            <div class=\"relative w-24 h-24 mx-auto mb-6\">\r\n                <div class=\"loader-pulse absolute inset-0 flex items-center justify-center\"></div>\r\n                <div class=\"loader-ring absolute inset-0\"></div>\r\n                <div class=\"absolute inset-0 flex items-center justify-center\">\r\n                    <svg class=\"w-8 h-8 text-orange-500\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\r\n                    </svg>\r\n                </div>\r\n            </div>\r\n            <!-- Loading text -->\r\n            <p class=\"text-white font-display text-xl mb-2\" id=\"loading-text\">Processing</p>\r\n            <!-- Animated dots -->\r\n            <div class=\"loader-dots\">\r\n                <span class=\"loader-dot\"></span>\r\n                <span class=\"loader-dot\"></span>\r\n                <span class=\"loader-dot\"></span>\r\n            </div>\r\n            <!-- Progress bar -->\r\n            <div class=\"progress-bar mx-auto mt-4\">\r\n                <div class=\"progress-fill\"></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class=\"container mx-auto px-4 py-3 max-w-md\">\r\n\r\n        <header class=\"flex items-center justify-between mb-4\" id=\"main-header\">\r\n            <div class=\"flex items-center gap-3\">\r\n                <img src=\"https://static.wixstatic.com/media/ccbabc_6f24b5754080485f876c17d8abb4d8ca~mv2.png/v1/fit/w_2500,h_1330,al_c/ccbabc_6f24b5754080485f876c17d8abb4d8ca~mv2.png\"\r\n                    alt=\"USC\" class=\"w-14 h-14 object-contain logo-glow rounded-xl\">\r\n                <div>\r\n                    <h1 class=\"font-display text-xl font-bold text-orange-500 tracking-wider\">UNI SPORTS COUNCIL, LPU\r\n                    </h1>\r\n                    <p class=\"text-muted text-xs tracking-widest uppercase\">Attendance System</p>\r\n                </div>\r\n            </div>\r\n            <div class=\"theme-toggle\" onclick=\"toggleTheme()\" id=\"theme-toggle\"></div>\r\n        </header>\r\n\r\n        <div class=\"energy-bar rounded-full mb-4\"></div>\r\n\r\n        <!-- ==================== PERMISSION CHECK SCREEN ==================== -->\r\n        <div id=\"screen-permission-check\" class=\"screen fade-in\">\r\n            <div class=\"card p-6 card-glow\">\r\n                <div class=\"text-center mb-6\">\r\n                    <div class=\"permission-icon pending\" id=\"perm-main-icon\">\r\n                        <svg class=\"w-10 h-10\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\r\n                        </svg>\r\n                    </div>\r\n                    <h2 class=\"font-display text-xl text-orange-500 tracking-wider\">PERMISSIONS REQUIRED</h2>\r\n                    <p class=\"text-muted text-sm mt-2\">This app needs access to your location and camera to work\r\n                        properly</p>\r\n                </div>\r\n\r\n                <div class=\"space-y-2 mb-6\">\r\n                    <!-- Location Permission -->\r\n                    <div class=\"check-item pending\" id=\"perm-location-item\">\r\n                        <div class=\"w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center\"\r\n                            id=\"perm-location-icon\">\r\n                            <svg class=\"w-5 h-5 text-yellow-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"flex-1\">\r\n                            <p class=\"font-semibold\">Location Access</p>\r\n                            <p class=\"text-muted text-xs\" id=\"perm-location-status\">Checking...</p>\r\n                        </div>\r\n                        <div id=\"perm-location-badge\">\r\n                            <span class=\"text-yellow-500 text-xs font-semibold\">PENDING</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <!-- Camera Permission -->\r\n                    <div class=\"check-item pending\" id=\"perm-camera-item\">\r\n                        <div class=\"w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center\"\r\n                            id=\"perm-camera-icon\">\r\n                            <svg class=\"w-5 h-5 text-yellow-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"flex-1\">\r\n                            <p class=\"font-semibold\">Camera Access</p>\r\n                            <p class=\"text-muted text-xs\" id=\"perm-camera-status\">Checking...</p>\r\n                        </div>\r\n                        <div id=\"perm-camera-badge\">\r\n                            <span class=\"text-yellow-500 text-xs font-semibold\">PENDING</span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <button onclick=\"requestPermissions()\"\r\n                    class=\"btn-primary w-full py-4 rounded-xl font-display text-lg text-white tracking-wider\"\r\n                    id=\"perm-grant-btn\">\r\n                    GRANT PERMISSIONS\r\n                </button>\r\n\r\n                <p class=\"text-muted text-xs text-center mt-4\">\r\n                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                            d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                    </svg>\r\n                    Your data is only used for attendance verification\r\n                </p>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ROLE SELECTION ==================== -->\r\n        <div id=\"screen-role-select\" class=\"screen hidden\">\r\n            <div class=\"card p-6 card-glow fade-in\">\r\n                <h2 class=\"font-display text-center text-xl text-orange-500 mb-6 tracking-wider\">SELECT MODE</h2>\r\n                <div class=\"space-y-3\">\r\n                    <!-- Admin Option -->\r\n                    <button onclick=\"showScreen('admin-login')\"\r\n                        class=\"w-full card p-5 flex items-center gap-4 hover:card-glow transition-all duration-300 group border-purple-500/30\">\r\n                        <div\r\n                            class=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-500/20 to-purple-600/10 flex items-center justify-center\">\r\n                            <svg class=\"w-7 h-7 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M12 11V9m0 6h.01\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"text-left flex-1\">\r\n                            <span class=\"font-display text-lg tracking-wide text-purple-400\">ADMIN</span>\r\n                            <p class=\"text-muted text-sm\">Full access ‚Ä¢ No burn code</p>\r\n                        </div>\r\n                        <svg class=\"w-5 h-5 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\" />\r\n                        </svg>\r\n                    </button>\r\n\r\n                    <!-- Verifier Option -->\r\n                    <button onclick=\"showScreen('verifier-login')\"\r\n                        class=\"w-full card p-5 flex items-center gap-4 hover:card-glow transition-all duration-300 group\">\r\n                        <div\r\n                            class=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-orange-500/20 to-orange-600/10 flex items-center justify-center\">\r\n                            <svg class=\"w-7 h-7 text-orange-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"text-left flex-1\"><span class=\"font-display text-lg tracking-wide\">VERIFIER</span>\r\n                            <p class=\"text-muted text-sm\">Requires burn code</p>\r\n                        </div>\r\n                        <svg class=\"w-5 h-5 text-orange-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\" />\r\n                        </svg>\r\n                    </button>\r\n\r\n                    <!-- Player/Volunteer Option -->\r\n                    <button onclick=\"showScreen('attendee-login')\"\r\n                        class=\"w-full card p-5 flex items-center gap-4 hover:card-glow transition-all duration-300 group\">\r\n                        <div\r\n                            class=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-cyan-600/10 flex items-center justify-center\">\r\n                            <svg class=\"w-7 h-7 text-cyan-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"text-left flex-1\"><span class=\"font-display text-lg tracking-wide\">PLAYER /\r\n                                VOLUNTEER</span>\r\n                            <p class=\"text-muted text-sm\">Mark your attendance</p>\r\n                        </div>\r\n                        <svg class=\"w-5 h-5 text-cyan-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\" />\r\n                        </svg>\r\n                    </button>\r\n\r\n                    <!-- My Profile Option (No login required) -->\r\n                    <button onclick=\"showScreen('volunteer-profile-lookup')\"\r\n                        class=\"w-full card p-5 flex items-center gap-4 hover:card-glow transition-all duration-300 group border-2 border-dashed border-green-500/30 hover:border-green-500\">\r\n                        <div\r\n                            class=\"w-14 h-14 rounded-2xl bg-gradient-to-br from-green-500/20 to-emerald-600/10 flex items-center justify-center\">\r\n                            <svg class=\"w-7 h-7 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                    d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\r\n                            </svg>\r\n                        </div>\r\n                        <div class=\"text-left flex-1\"><span class=\"font-display text-lg tracking-wide\">MY PROFILE</span>\r\n                            <p class=\"text-muted text-sm\">View stats, history & leaderboard</p>\r\n                        </div>\r\n                        <svg class=\"w-5 h-5 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\" />\r\n                        </svg>\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== VOLUNTEER PROFILE LOOKUP ==================== -->\r\n        <div id=\"screen-volunteer-profile-lookup\" class=\"screen hidden\">\r\n            <div class=\"card p-5 fade-in\" style=\"border-color: rgba(34, 197, 94, 0.3);\">\r\n                <button onclick=\"showScreen('role-select')\"\r\n                    class=\"text-muted hover:text-green-500 mb-3 flex items-center gap-1 text-sm font-medium\">\r\n                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>Back\r\n                </button>\r\n                <h2 class=\"font-display text-center text-xl text-green-500 mb-5 tracking-wider\">üèÜ VOLUNTEER PROFILE\r\n                </h2>\r\n\r\n                <form id=\"profile-lookup-form\" class=\"space-y-4\">\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Your Reg No</label>\r\n                        <input type=\"tel\" id=\"profile-regno\" maxlength=\"8\" pattern=\"[0-9]{8}\" minlength=\"8\" inputmode=\"numeric\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-center text-2xl tracking-[0.3em] font-display\"\r\n                            placeholder=\"12345678\" required style=\"border-color: rgba(34, 197, 94, 0.3);\">\r\n                    </div>\r\n                    <button type=\"submit\"\r\n                        class=\"w-full py-3 rounded-xl font-display tracking-wider bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white transition-all font-semibold\">\r\n                        VIEW MY STATS\r\n                    </button>\r\n                </form>\r\n\r\n                <div class=\"mt-4 text-center\">\r\n                    <button onclick=\"showPublicLeaderboard()\"\r\n                        class=\"text-green-400 hover:text-green-300 text-sm font-medium\">\r\n                        üìä View Full Leaderboard\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== VOLUNTEER PROFILE DISPLAY ==================== -->\r\n        <div id=\"screen-volunteer-profile\" class=\"screen hidden\">\r\n            <div class=\"fade-in\">\r\n                <button onclick=\"showScreen('volunteer-profile-lookup')\"\r\n                    class=\"text-muted hover:text-green-500 mb-3 flex items-center gap-1 text-sm font-medium\">\r\n                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>Back\r\n                </button>\r\n\r\n                <!-- Profile Header -->\r\n                <div class=\"card p-4 mb-4 border-2 border-green-500/30 text-center\">\r\n                    <p class=\"font-display text-2xl text-green-400\" id=\"profile-name\">Loading...</p>\r\n                    <p class=\"text-muted text-xs\" id=\"profile-regno-display\">Reg No</p>\r\n                    <p class=\"text-muted text-xs mt-1\">Member since <span id=\"profile-joined\">-</span></p>\r\n                </div>\r\n\r\n                <!-- Stats Grid -->\r\n                <div class=\"grid grid-cols-4 gap-2 mb-4\">\r\n                    <div class=\"card p-3 text-center\">\r\n                        <p class=\"font-display text-2xl text-orange-400\" id=\"profile-hours\">0</p>\r\n                        <p class=\"text-muted text-xs\">Hours</p>\r\n                    </div>\r\n                    <div class=\"card p-3 text-center\">\r\n                        <p class=\"font-display text-2xl text-cyan-400\" id=\"profile-events\">0</p>\r\n                        <p class=\"text-muted text-xs\">Events</p>\r\n                    </div>\r\n                    <div class=\"card p-3 text-center\">\r\n                        <p class=\"font-display text-2xl text-purple-400\" id=\"profile-days\">0</p>\r\n                        <p class=\"text-muted text-xs\">Days</p>\r\n                    </div>\r\n                    <div class=\"card p-3 text-center\">\r\n                        <p class=\"font-display text-2xl text-yellow-400\" id=\"profile-rank\">#-</p>\r\n                        <p class=\"text-muted text-xs\">Rank</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Badges -->\r\n                <div class=\"card p-4 mb-4\">\r\n                    <h3 class=\"font-display text-sm text-green-400 tracking-wider mb-3\">üèÖ BADGES EARNED</h3>\r\n                    <div id=\"profile-badges\" class=\"flex flex-wrap gap-2 justify-center\">\r\n                        <p class=\"text-muted text-sm\">No badges yet</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Event History -->\r\n                <div class=\"card p-4 mb-4\">\r\n                    <h3 class=\"font-display text-sm text-green-400 tracking-wider mb-3\">üìÖ EVENT HISTORY</h3>\r\n                    <div id=\"profile-history\" class=\"max-h-64 overflow-y-auto space-y-2\">\r\n                        <p class=\"text-muted text-sm text-center py-2\">Loading...</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Actions -->\r\n                <button onclick=\"showPublicLeaderboard()\"\r\n                    class=\"w-full card p-4 text-center hover:card-glow transition border-2 border-dashed border-purple-500/30 hover:border-purple-500\">\r\n                    <span class=\"font-display text-lg tracking-wider text-purple-400\">üèÜ VIEW LEADERBOARD</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ADMIN LOGIN ==================== -->\r\n        <div id=\"screen-admin-login\" class=\"screen hidden\">\r\n            <div class=\"card p-5 fade-in\" style=\"border-color: rgba(124, 58, 237, 0.3);\">\r\n                <button onclick=\"showScreen('role-select')\"\r\n                    class=\"text-muted hover:text-purple-500 mb-3 flex items-center gap-1 text-sm font-medium\">\r\n                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>Back\r\n                </button>\r\n                <h2 class=\"font-display text-center text-xl text-purple-500 mb-5 tracking-wider\">ADMIN LOGIN</h2>\r\n                <form id=\"admin-login-form\" class=\"space-y-3\" autocomplete=\"off\">\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Admin ID</label>\r\n                        <input type=\"tel\" id=\"admin-id\" minlength=\"5\" maxlength=\"5\" pattern=\"[0-9]{5}\" autocomplete=\"off\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-center text-2xl tracking-[0.5em] font-display\"\r\n                            placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\" required style=\"border-color: rgba(124, 58, 237, 0.3);\">\r\n                    </div>\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Password</label>\r\n                        <input type=\"password\" id=\"admin-password\" class=\"input-field w-full px-4 py-3 rounded-xl mt-1\"\r\n                            placeholder=\"Enter password\" required maxlength=\"128\" autocomplete=\"current-password\" style=\"border-color: rgba(124, 58, 237, 0.3);\">\r\n                    </div>\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Event <span\r\n                                class=\"text-purple-400\">(Optional for Admin)</span></label>\r\n                        <select id=\"admin-event\" class=\"input-field w-full px-4 py-3 rounded-xl mt-1\"\r\n                            style=\"border-color: rgba(124, 58, 237, 0.3);\">\r\n                            <option value=\"\">Loading...</option>\r\n                        </select>\r\n                    </div>\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Location\r\n                            (Optional)</label>\r\n                        <input type=\"text\" id=\"admin-location\" class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" maxlength=\"200\"\r\n                            placeholder=\"e.g. Main Gate\" style=\"border-color: rgba(124, 58, 237, 0.3);\">\r\n                    </div>\r\n                    <button type=\"submit\"\r\n                        class=\"btn-admin w-full py-4 rounded-xl font-display text-lg text-white tracking-wider mt-4\">\r\n                        LOGIN AS ADMIN\r\n                    </button>\r\n                </form>\r\n                <p class=\"text-muted text-xs text-center mt-4\">\r\n                    <svg class=\"w-4 h-4 inline mr-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                            d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\r\n                    </svg>\r\n                    Admin access is locked to one device per day\r\n                </p>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== VERIFIER LOGIN ==================== -->\r\n        <div id=\"screen-verifier-login\" class=\"screen hidden\">\r\n            <div class=\"card p-5 fade-in\">\r\n                <button onclick=\"showScreen('role-select')\"\r\n                    class=\"text-muted hover:text-orange-500 mb-3 flex items-center gap-1 text-sm font-medium\">\r\n                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>Back\r\n                </button>\r\n                <h2 class=\"font-display text-center text-xl text-orange-500 mb-5 tracking-wider\">VERIFIER LOGIN</h2>\r\n                <form id=\"verifier-login-form\" class=\"space-y-3\">\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Reg\r\n                            Number</label><input type=\"tel\" id=\"ver-regno\" maxlength=\"8\" pattern=\"[0-9]{8}\" minlength=\"8\" inputmode=\"numeric\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-lg\" placeholder=\"8 digits\"\r\n                            required></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Full\r\n                            Name</label><input type=\"text\" id=\"ver-name\" maxlength=\"100\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" placeholder=\"Your name\" required></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Event</label><select\r\n                            id=\"ver-event\" class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" required>\r\n                            <option value=\"\">Loading...</option>\r\n                        </select></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Location\r\n                            (Optional)</label><input type=\"text\" id=\"ver-location\" maxlength=\"200\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" placeholder=\"e.g. Gate A\"></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Burn\r\n                            Code</label><input type=\"text\" id=\"ver-code\" maxlength=\"6\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-center text-2xl tracking-[0.5em] font-display\"\r\n                            placeholder=\"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢\" required></div>\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Face\r\n                            Verification</label>\r\n                        <div class=\"relative mt-1 rounded-xl overflow-hidden bg-gray-900 aspect-[4/3]\">\r\n                            <video id=\"ver-camera\" autoplay playsinline muted\r\n                                class=\"w-full h-full object-cover webcam-mirror\"></video>\r\n                            <img id=\"ver-captured-img\" class=\"w-full h-full object-cover webcam-mirror\"\r\n                                style=\"display:none;\">\r\n                            <canvas id=\"ver-canvas\" class=\"hidden\"></canvas>\r\n                            <div class=\"face-oval\" id=\"ver-face-oval\"></div>\r\n                            <div id=\"ver-face-status\"\r\n                                class=\"absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/80 text-white text-xs px-4 py-2 rounded-full flex items-center gap-2\">\r\n                                <span class=\"w-2 h-2 bg-orange-500 rounded-full status-pulse\"></span><span>Position your\r\n                                    face</span>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <button type=\"submit\"\r\n                        class=\"btn-primary w-full py-4 rounded-xl font-display text-lg text-white tracking-wider mt-4\">START\r\n                        SESSION</button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== DASHBOARD (Admin & Verifier) ==================== -->\r\n        <div id=\"screen-verifier-dashboard\" class=\"screen hidden\">\r\n            <div class=\"fade-in\">\r\n                <div class=\"flex justify-between items-center mb-4\">\r\n                    <div>\r\n                        <p class=\"text-muted text-xs uppercase tracking-wider\">Welcome</p>\r\n                        <h2 class=\"font-display text-xl\" id=\"ver-dash-name\">Verifier</h2>\r\n                        <span class=\"text-xs px-2 py-0.5 rounded-full hidden\" id=\"admin-badge\"\r\n                            style=\"background: rgba(124, 58, 237, 0.2); color: #a78bfa;\">ADMIN</span>\r\n                    </div>\r\n                    <button onclick=\"verifierLogout()\"\r\n                        class=\"bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-xl text-sm font-semibold transition\">Logout</button>\r\n                </div>\r\n                <!-- End Shift button (volunteers only, hidden for admins) -->\r\n                <button onclick=\"endShift()\" id=\"end-shift-btn\"\r\n                    class=\"w-full mb-3 bg-gradient-to-r from-orange-500/20 to-red-500/20 hover:from-orange-500/30 hover:to-red-500/30 text-orange-400 px-4 py-2.5 rounded-xl text-sm font-semibold transition border border-orange-500/30 hidden\">\r\n                    üîö End Shift &amp; Mark Attendance OUT\r\n                </button>\r\n                <!-- Auto-attendance indicator badge (volunteers only) -->\r\n                <div id=\"auto-attendance-badge\" class=\"hidden mb-3 flex items-center justify-center gap-2 text-xs text-green-400 bg-green-500/10 border border-green-500/20 rounded-lg py-1.5 px-3\">\r\n                    <span class=\"w-1.5 h-1.5 bg-green-400 rounded-full status-pulse\"></span>\r\n                    Your attendance is auto-tracked for this event\r\n                </div>\r\n\r\n                <div class=\"card p-4 mb-4 border-2 card-glow\" id=\"event-card\"\r\n                    style=\"border-color: rgba(255, 107, 0, 0.5);\">\r\n                    <div class=\"flex items-center justify-between\">\r\n                        <div>\r\n                            <p class=\"text-muted text-xs uppercase tracking-wider\">Event</p>\r\n                            <p class=\"font-display text-lg text-orange-500\" id=\"ver-dash-event\">Event</p>\r\n                            <p class=\"text-muted text-xs\" id=\"ver-dash-location\"></p>\r\n                        </div>\r\n                        <div\r\n                            class=\"flex items-center gap-2 bg-green-500/20 text-green-400 px-3 py-1.5 rounded-full text-sm font-semibold\">\r\n                            <span class=\"w-2 h-2 bg-green-400 rounded-full status-pulse\"></span>LIVE\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"card p-5 mb-4 text-center\">\r\n                    <p class=\"text-muted text-sm mb-3\">Students scan this QR</p>\r\n                    <div class=\"qr-frame inline-block\">\r\n                        <div id=\"qr-display\"><span class=\"text-gray-400 text-sm\">Generating...</span></div>\r\n                    </div>\r\n                    <p class=\"text-muted text-xs mt-3 flex items-center justify-center gap-2\">\r\n                        <svg class=\"w-4 h-4 animate-spin\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n                        </svg>\r\n                        Auto-refreshes every 5s\r\n                    </p>\r\n                </div>\r\n\r\n                <div class=\"grid grid-cols-3 gap-3 mb-4\">\r\n                    <div class=\"card p-4 text-center\">\r\n                        <p class=\"font-display text-3xl stat-number\" id=\"stat-in\">0</p>\r\n                        <p class=\"text-muted text-xs uppercase tracking-wider\">In Now</p>\r\n                    </div>\r\n                    <div class=\"card p-4 text-center\">\r\n                        <p class=\"font-display text-3xl text-cyan-500\" id=\"stat-total\">0</p>\r\n                        <p class=\"text-muted text-xs uppercase tracking-wider\">Total</p>\r\n                    </div>\r\n                    <div class=\"card p-4 text-center\">\r\n                        <p class=\"font-display text-3xl text-purple-500\" id=\"stat-out\">0</p>\r\n                        <p class=\"text-muted text-xs uppercase tracking-wider\">Out</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Pending Verification Section -->\r\n                <div id=\"pending-section\" class=\"card p-4 mb-4 hidden border-2 border-yellow-500/30\">\r\n                    <div class=\"flex items-center justify-between mb-3\">\r\n                        <h3 class=\"font-display text-sm text-yellow-400 tracking-wider flex items-center gap-2\">\r\n                            <span class=\"w-2 h-2 bg-yellow-400 rounded-full animate-pulse\"></span>\r\n                            PENDING VERIFICATION\r\n                        </h3>\r\n                        <span class=\"bg-yellow-500/20 text-yellow-400 px-2 py-0.5 rounded-full text-xs font-display\"\r\n                            id=\"pending-count\">0</span>\r\n                    </div>\r\n                    <div id=\"pending-list\" class=\"max-h-40 overflow-y-auto\"></div>\r\n                </div>\r\n\r\n                <!-- Volunteer Stats Section (only for verifiers, not admins) -->\r\n                <div id=\"volunteer-stats-section\" class=\"card p-4 mb-4 border-2 border-cyan-500/30\">\r\n                    <h3 class=\"font-display text-sm text-cyan-400 tracking-wider mb-3 flex items-center gap-2\">\r\n                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\r\n                        </svg>\r\n                        MY STATS\r\n                    </h3>\r\n                    <div id=\"volunteer-stats-container\">\r\n                        <p class=\"text-muted text-sm text-center py-2\">Loading stats...</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <button onclick=\"openManualEntry()\"\r\n                    class=\"w-full card p-4 flex items-center justify-center gap-3 hover:card-glow transition-all mb-4 border-2 border-dashed border-orange-500/30 hover:border-orange-500\"\r\n                    id=\"manual-entry-btn\">\r\n                    <svg class=\"w-6 h-6 text-orange-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                            d=\"M12 6v6m0 0v6m0-6h6m-6 0H6\" />\r\n                    </svg>\r\n                    <span class=\"font-display text-lg tracking-wider\">MANUAL ENTRY</span>\r\n                </button>\r\n\r\n                <div class=\"card p-4\">\r\n                    <h3 class=\"font-display text-sm text-orange-500 mb-3 tracking-wider\">CURRENTLY IN</h3>\r\n                    <div id=\"students-list\" class=\"max-h-48 overflow-y-auto space-y-2\">\r\n                        <p class=\"text-muted text-sm text-center py-4\">No one yet</p>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Admin Dashboard Button (only shown for admins) -->\r\n                <button onclick=\"openAdminDashboard()\" id=\"open-admin-dash-btn\"\r\n                    class=\"hidden w-full card p-4 flex items-center justify-center gap-3 hover:card-glow transition-all mt-4 border-2 border-purple-500/30 hover:border-purple-500\">\r\n                    <svg class=\"w-6 h-6 text-purple-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                            d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                            d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                    </svg>\r\n                    <span class=\"font-display text-lg tracking-wider text-purple-400\">ADMIN PANEL</span>\r\n                </button>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ADMIN DASHBOARD ==================== -->\r\n        <div id=\"screen-admin-dashboard\" class=\"screen hidden\">\r\n            <div class=\"fade-in\">\r\n                <div class=\"flex justify-between items-center mb-3\">\r\n                    <div>\r\n                        <p class=\"text-muted text-xs uppercase tracking-wider\">Admin Dashboard</p>\r\n                        <h2 class=\"font-display text-lg text-purple-400\" id=\"admin-dash-event\">Event</h2>\r\n                    </div>\r\n                    <button onclick=\"closeAdminDashboard()\"\r\n                        class=\"bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 px-3 py-2 rounded-xl text-sm font-semibold transition\">‚Üê\r\n                        Back</button>\r\n                </div>\r\n\r\n                <!-- Admin Tabs -->\r\n                <div class=\"admin-tabs mb-3\">\r\n                    <div class=\"admin-tab active\" onclick=\"switchAdminTab('stats')\">üìä Stats</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('attendance')\">üìã Records</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('events')\">üìÖ Events</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('codes')\">üé´ Codes</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('blacklist')\">üö´ Blacklist</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('activity')\">‚ö†Ô∏è Activity</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('verifiers')\">üë• Verifiers</div>\r\n                    <div class=\"admin-tab\" onclick=\"switchAdminTab('admins')\">üîë Admins</div>\r\n                </div>\r\n\r\n                <!-- Stats Panel -->\r\n                <div id=\"panel-stats\" class=\"admin-panel active\">\r\n                    <div class=\"grid grid-cols-2 gap-2 mb-3\">\r\n                        <div class=\"stat-card\">\r\n                            <div class=\"stat-card-value text-green-400\" id=\"adm-stat-in\">0</div>\r\n                            <div class=\"stat-card-label\">Currently In</div>\r\n                        </div>\r\n                        <div class=\"stat-card\">\r\n                            <div class=\"stat-card-value text-cyan-400\" id=\"adm-stat-total\">0</div>\r\n                            <div class=\"stat-card-label\">Total Today</div>\r\n                        </div>\r\n                        <div class=\"stat-card\">\r\n                            <div class=\"stat-card-value text-purple-400\" id=\"adm-stat-out\">0</div>\r\n                            <div class=\"stat-card-label\">Checked Out</div>\r\n                        </div>\r\n                        <div class=\"stat-card\">\r\n                            <div class=\"stat-card-value text-orange-400\" id=\"adm-stat-verifiers\">0</div>\r\n                            <div class=\"stat-card-label\">Verifiers</div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"card p-3 mb-3\">\r\n                        <h4 class=\"text-xs font-semibold text-muted mb-2\">ROLE BREAKDOWN</h4>\r\n                        <div class=\"flex gap-2\">\r\n                            <div class=\"flex-1 bg-green-500/10 p-2 rounded-lg text-center\">\r\n                                <div class=\"font-display text-lg text-green-400\" id=\"adm-role-players\">0</div>\r\n                                <div class=\"text-xs text-muted\">Players</div>\r\n                            </div>\r\n                            <div class=\"flex-1 bg-blue-500/10 p-2 rounded-lg text-center\">\r\n                                <div class=\"font-display text-lg text-blue-400\" id=\"adm-role-volunteers\">0</div>\r\n                                <div class=\"text-xs text-muted\">Volunteers</div>\r\n                            </div>\r\n                            <div class=\"flex-1 bg-gray-500/10 p-2 rounded-lg text-center\">\r\n                                <div class=\"font-display text-lg text-gray-400\" id=\"adm-role-others\">0</div>\r\n                                <div class=\"text-xs text-muted\">Others</div>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div class=\"flex gap-2\">\r\n                        <button onclick=\"exportAttendance()\" class=\"flex-1 mini-btn mini-btn-green\">üì• Export\r\n                            CSV</button>\r\n                        <button onclick=\"loadAdminStats()\" class=\"flex-1 mini-btn mini-btn-purple\">üîÑ Refresh</button>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Attendance Records Panel -->\r\n                <div id=\"panel-attendance\" class=\"admin-panel\">\r\n                    <div class=\"flex gap-2 mb-3\">\r\n                        <input type=\"text\" id=\"adm-search\" class=\"admin-input flex-1\" maxlength=\"50\" placeholder=\"Search RegNo/Name...\"\r\n                            onkeyup=\"searchAttendance()\">\r\n                        <input type=\"date\" id=\"adm-date-from\" class=\"admin-input w-28\"\r\n                            onchange=\"loadAttendanceRecords()\">\r\n                    </div>\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 350px; overflow-y: auto;\">\r\n                        <table class=\"data-table\" id=\"attendance-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>RegNo</th>\r\n                                    <th>Name</th>\r\n                                    <th>In</th>\r\n                                    <th>Out</th>\r\n                                    <th>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"attendance-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"5\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                    <div class=\"flex justify-between items-center mt-2 text-xs text-muted\">\r\n                        <span id=\"att-page-info\">Page 1</span>\r\n                        <div class=\"flex gap-2\">\r\n                            <button onclick=\"prevAttPage()\" class=\"mini-btn mini-btn-purple\">‚Üê Prev</button>\r\n                            <button onclick=\"nextAttPage()\" class=\"mini-btn mini-btn-purple\">Next ‚Üí</button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Events Panel -->\r\n                <div id=\"panel-events\" class=\"admin-panel\">\r\n                    <button onclick=\"showCreateEventModal()\" class=\"w-full mini-btn mini-btn-green mb-3\">+ Create New\r\n                        Event</button>\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 300px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Event Name</th>\r\n                                    <th>Dates</th>\r\n                                    <th>Status</th>\r\n                                    <th>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"events-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"4\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Burn Codes Panel -->\r\n                <div id=\"panel-codes\" class=\"admin-panel\">\r\n                    <div class=\"flex gap-2 mb-3\">\r\n                        <button onclick=\"generateNewCodes()\" class=\"flex-1 mini-btn mini-btn-green\">+ Generate 10\r\n                            Codes</button>\r\n                        <select id=\"code-filter\" class=\"admin-select\" onchange=\"loadBurnCodes()\">\r\n                            <option value=\"all\">All</option>\r\n                            <option value=\"Active\">Active</option>\r\n                            <option value=\"Burned\">Used</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 300px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Code</th>\r\n                                    <th>Status</th>\r\n                                    <th>Used By</th>\r\n                                    <th>Date</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"codes-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"4\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Blacklist Panel -->\r\n                <div id=\"panel-blacklist\" class=\"admin-panel\">\r\n                    <div class=\"card p-3 mb-3\">\r\n                        <h4 class=\"text-xs font-semibold text-muted mb-2\">ADD TO BLACKLIST</h4>\r\n                        <div class=\"flex gap-2\">\r\n                            <select id=\"bl-type\" class=\"admin-select\">\r\n                                <option value=\"RegNo\">Reg No</option>\r\n                                <option value=\"Device\">Device ID</option>\r\n                            </select>\r\n                            <input type=\"text\" id=\"bl-value\" class=\"admin-input flex-1\" maxlength=\"100\" placeholder=\"Value\">\r\n                        </div>\r\n                        <input type=\"text\" id=\"bl-reason\" class=\"admin-input w-full mt-2\" maxlength=\"200\" placeholder=\"Reason\">\r\n                        <button onclick=\"addBlacklistEntry()\" class=\"mini-btn mini-btn-red w-full mt-2\">+ Add to\r\n                            Blacklist</button>\r\n                    </div>\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 200px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Type</th>\r\n                                    <th>Value</th>\r\n                                    <th>Reason</th>\r\n                                    <th>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"blacklist-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"4\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Suspicious Activity Panel -->\r\n                <div id=\"panel-activity\" class=\"admin-panel\">\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 350px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Time</th>\r\n                                    <th>RegNo</th>\r\n                                    <th>Type</th>\r\n                                    <th>Details</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"activity-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"4\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                    <button onclick=\"loadSuspiciousActivity()\" class=\"w-full mini-btn mini-btn-purple mt-2\">üîÑ\r\n                        Refresh</button>\r\n                </div>\r\n\r\n                <!-- Active Verifiers Panel -->\r\n                <div id=\"panel-verifiers\" class=\"admin-panel\">\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 300px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>RegNo</th>\r\n                                    <th>Name</th>\r\n                                    <th>Event</th>\r\n                                    <th>Location</th>\r\n                                    <th>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"verifiers-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"5\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                    <button onclick=\"loadActiveVerifiers()\" class=\"w-full mini-btn mini-btn-purple mt-2\">üîÑ\r\n                        Refresh</button>\r\n                </div>\r\n\r\n                <!-- Admin Accounts Panel -->\r\n                <div id=\"panel-admins\" class=\"admin-panel\">\r\n                    <div class=\"card p-3 mb-3\">\r\n                        <h4 class=\"text-xs font-semibold text-muted mb-2\">ADD ADMIN ACCOUNT</h4>\r\n                        <div class=\"flex gap-2 mb-2\">\r\n                            <input type=\"tel\" id=\"new-admin-id\" class=\"admin-input flex-1\" placeholder=\"5-digit ID\"\r\n                                maxlength=\"5\">\r\n                            <input type=\"password\" id=\"new-admin-pass\" class=\"admin-input flex-1\" maxlength=\"128\" autocomplete=\"new-password\"\r\n                                placeholder=\"Password\">\r\n                        </div>\r\n                        <button onclick=\"addNewAdmin()\" class=\"mini-btn mini-btn-purple w-full\">+ Add Admin</button>\r\n                    </div>\r\n                    <div class=\"card p-2 overflow-x-auto\" style=\"max-height: 200px; overflow-y: auto;\">\r\n                        <table class=\"data-table\">\r\n                            <thead>\r\n                                <tr>\r\n                                    <th>Admin ID</th>\r\n                                    <th>Status</th>\r\n                                    <th>Action</th>\r\n                                </tr>\r\n                            </thead>\r\n                            <tbody id=\"admins-tbody\">\r\n                                <tr>\r\n                                    <td colspan=\"3\" class=\"text-center text-muted py-4\">Loading...</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n\r\n                <!-- Student Search Panel (Modal-like) -->\r\n                <div id=\"student-search-result\" class=\"hidden card p-3 mt-3\">\r\n                    <div class=\"flex justify-between items-center mb-2\">\r\n                        <h4 class=\"font-display text-sm text-orange-500\">STUDENT DETAILS</h4>\r\n                        <button onclick=\"document.getElementById('student-search-result').classList.add('hidden')\"\r\n                            class=\"text-muted text-xs\">‚úï Close</button>\r\n                    </div>\r\n                    <div id=\"student-info\"></div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== CREATE EVENT MODAL ==================== -->\r\n        <div id=\"create-event-modal\"\r\n            class=\"fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-5 w-full max-w-sm\">\r\n                <div class=\"flex justify-between items-center mb-4\">\r\n                    <h3 class=\"font-display text-lg text-purple-400\">CREATE EVENT</h3>\r\n                    <button onclick=\"document.getElementById('create-event-modal').classList.add('hidden')\"\r\n                        class=\"text-muted hover:text-white\">‚úï</button>\r\n                </div>\r\n                <div class=\"space-y-3\">\r\n                    <input type=\"text\" id=\"evt-name\" class=\"admin-input\" maxlength=\"100\" placeholder=\"Event Name\">\r\n                    <div class=\"grid grid-cols-2 gap-2\">\r\n                        <input type=\"date\" id=\"evt-start-date\" class=\"admin-input\">\r\n                        <input type=\"date\" id=\"evt-end-date\" class=\"admin-input\">\r\n                    </div>\r\n                    <div class=\"grid grid-cols-2 gap-2\">\r\n                        <input type=\"time\" id=\"evt-start-time\" class=\"admin-input\" placeholder=\"Start Time\">\r\n                        <input type=\"time\" id=\"evt-end-time\" class=\"admin-input\" placeholder=\"End Time\">\r\n                    </div>\r\n                    <input type=\"text\" id=\"evt-location\" class=\"admin-input\" maxlength=\"200\" placeholder=\"Location\">\r\n                    <button onclick=\"createNewEvent()\"\r\n                        class=\"btn-admin w-full py-3 rounded-xl font-display text-white\">CREATE EVENT</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== EDIT ATTENDANCE MODAL ==================== -->\r\n        <div id=\"edit-attendance-modal\"\r\n            class=\"fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-5 w-full max-w-sm\">\r\n                <div class=\"flex justify-between items-center mb-4\">\r\n                    <h3 class=\"font-display text-lg text-orange-500\">EDIT ATTENDANCE</h3>\r\n                    <button onclick=\"document.getElementById('edit-attendance-modal').classList.add('hidden')\"\r\n                        class=\"text-muted hover:text-white\">‚úï</button>\r\n                </div>\r\n                <input type=\"hidden\" id=\"edit-row-index\">\r\n                <div class=\"space-y-3\">\r\n                    <div><label class=\"text-muted text-xs\">Student</label>\r\n                        <p id=\"edit-student-name\" class=\"font-semibold\"></p>\r\n                    </div>\r\n                    <div class=\"grid grid-cols-2 gap-2\">\r\n                        <div><label class=\"text-muted text-xs\">Time In</label><input type=\"time\" id=\"edit-time-in\"\r\n                                class=\"admin-input\"></div>\r\n                        <div><label class=\"text-muted text-xs\">Time Out</label><input type=\"time\" id=\"edit-time-out\"\r\n                                class=\"admin-input\"></div>\r\n                    </div>\r\n                    <div><label class=\"text-muted text-xs\">Flag/Note</label><input type=\"text\" id=\"edit-flag\" maxlength=\"200\"\r\n                            class=\"admin-input\" placeholder=\"e.g. Late, Early leave\"></div>\r\n                    <div class=\"flex gap-2\">\r\n                        <button onclick=\"saveAttendanceEdit()\"\r\n                            class=\"flex-1 btn-primary py-3 rounded-xl font-display text-white\">SAVE</button>\r\n                        <button onclick=\"deleteAttendanceEntry()\"\r\n                            class=\"mini-btn mini-btn-red py-3 px-4\">Delete</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ATTENDEE LOGIN ==================== -->\r\n        <div id=\"screen-attendee-login\" class=\"screen hidden\">\r\n            <div class=\"card p-5 fade-in\">\r\n                <button onclick=\"showScreen('role-select')\"\r\n                    class=\"text-muted hover:text-orange-500 mb-3 flex items-center gap-1 text-sm font-medium\">\r\n                    <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                    </svg>Back\r\n                </button>\r\n                <h2 class=\"font-display text-center text-xl text-orange-500 mb-5 tracking-wider\">MARK ATTENDANCE</h2>\r\n                <form id=\"attendee-login-form\" class=\"space-y-3\">\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Full\r\n                            Name</label><input type=\"text\" id=\"att-name\" maxlength=\"100\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" placeholder=\"Your name\" required></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Reg\r\n                            Number</label><input type=\"tel\" id=\"att-regno\" maxlength=\"8\" pattern=\"[0-9]{8}\" minlength=\"8\" inputmode=\"numeric\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-lg\" placeholder=\"8 digits\"\r\n                            required></div>\r\n                    <div>\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider mb-2 block\">I am</label>\r\n                        <div class=\"grid grid-cols-2 gap-3\">\r\n                            <div class=\"role-card card p-4 text-center selected\" data-role=\"Player\"\r\n                                onclick=\"selectRole(this)\">\r\n                                <svg class=\"w-8 h-8 mx-auto mb-2 text-orange-500\" fill=\"none\" stroke=\"currentColor\"\r\n                                    viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                        d=\"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\" />\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                        d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                                </svg>\r\n                                <span class=\"font-display tracking-wider\">PLAYER</span>\r\n                            </div>\r\n                            <div class=\"role-card card p-4 text-center\" data-role=\"Volunteer\"\r\n                                onclick=\"selectRole(this)\">\r\n                                <svg class=\"w-8 h-8 mx-auto mb-2 text-cyan-500\" fill=\"none\" stroke=\"currentColor\"\r\n                                    viewBox=\"0 0 24 24\">\r\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                        d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z\" />\r\n                                </svg>\r\n                                <span class=\"font-display tracking-wider\">VOLUNTEER</span>\r\n                                <p class=\"text-muted text-xs\">Duty Leave</p>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <input type=\"hidden\" id=\"att-role\" value=\"Player\">\r\n                    <button type=\"submit\"\r\n                        class=\"btn-primary w-full py-4 rounded-xl font-display text-lg text-white tracking-wider mt-4\">SCAN\r\n                        QR CODE</button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ATTENDEE SCANNER ==================== -->\r\n        <div id=\"screen-attendee-scanner\" class=\"screen hidden\">\r\n            <div class=\"fade-in\">\r\n                <div class=\"flex justify-between items-center mb-3\">\r\n                    <button onclick=\"stopScannerAndGoBack()\"\r\n                        class=\"text-muted hover:text-orange-500 flex items-center gap-1 text-sm font-medium\">\r\n                        <svg class=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\" />\r\n                        </svg>Back\r\n                    </button>\r\n                    <div class=\"text-right\">\r\n                        <p class=\"font-semibold\" id=\"att-dash-name\">Name</p>\r\n                        <p class=\"text-orange-500 text-sm font-display\" id=\"att-dash-role\">Player</p>\r\n                    </div>\r\n                </div>\r\n                <div id=\"att-status-box\" class=\"card p-3 mb-3 text-center\">\r\n                    <p class=\"text-muted text-xs uppercase tracking-wider\">Status</p>\r\n                    <p class=\"font-display text-xl text-orange-500\" id=\"att-status-text\">Ready</p>\r\n                </div>\r\n                <div class=\"card p-4\">\r\n                    <h2 class=\"font-display text-center text-lg text-orange-500 mb-3 tracking-wider\">SCAN VERIFIER QR\r\n                    </h2>\r\n                    <div class=\"scanner-frame relative bg-gray-900 aspect-square rounded-xl overflow-hidden\">\r\n                        <div id=\"reader\" class=\"w-full h-full\"></div>\r\n                        <div class=\"scan-line\"></div>\r\n                    </div>\r\n                    <p class=\"text-muted text-sm text-center mt-3\">Point camera at verifier's screen</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== MANUAL ENTRY MODAL ==================== -->\r\n        <div id=\"manual-entry-modal\"\r\n            class=\"fixed inset-0 bg-black/90 backdrop-blur-md z-40 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-5 w-full max-w-sm fade-in card-glow\">\r\n                <div class=\"flex justify-between items-center mb-4\">\r\n                    <h2 class=\"font-display text-lg text-orange-500 tracking-wider\">MANUAL ENTRY</h2>\r\n                    <button onclick=\"closeManualEntry()\" class=\"text-muted hover:text-white p-2\"><svg class=\"w-5 h-5\"\r\n                            fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                d=\"M6 18L18 6M6 6l12 12\" />\r\n                        </svg></button>\r\n                </div>\r\n                <form id=\"manual-entry-form\" class=\"space-y-3\">\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Student Reg\r\n                            No</label><input type=\"tel\" id=\"manual-regno\" minlength=\"8\" maxlength=\"8\" pattern=\"[0-9]{8}\" pattern=\"[0-9]{5,8}\" inputmode=\"numeric\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1 text-lg\" placeholder=\"8 digits\"\r\n                            required></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Student\r\n                            Name</label><input type=\"text\" id=\"manual-name\" maxlength=\"100\"\r\n                            class=\"input-field w-full px-4 py-3 rounded-xl mt-1\" placeholder=\"Full name\" required></div>\r\n                    <div><label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Role</label><select\r\n                            id=\"manual-role\" class=\"input-field w-full px-4 py-3 rounded-xl mt-1\">\r\n                            <option value=\"Player\">Player</option>\r\n                            <option value=\"Volunteer\">Volunteer (Duty)</option>\r\n                        </select></div>\r\n\r\n                    <!-- Camera section - hidden for admin -->\r\n                    <div id=\"manual-camera-section\">\r\n                        <label class=\"text-muted text-xs font-semibold uppercase tracking-wider\">Photo Proof</label>\r\n                        <div class=\"relative mt-1 rounded-xl overflow-hidden bg-gray-900 aspect-[4/3]\">\r\n                            <video id=\"manual-camera\" autoplay playsinline muted\r\n                                class=\"w-full h-full object-cover\"></video>\r\n                            <img id=\"manual-captured-img\" class=\"w-full h-full object-cover\" style=\"display:none;\">\r\n                            <canvas id=\"manual-canvas\" class=\"hidden\"></canvas>\r\n                            <div class=\"face-oval\" id=\"manual-face-oval\"></div>\r\n                            <div id=\"manual-face-status\"\r\n                                class=\"absolute bottom-3 left-1/2 -translate-x-1/2 bg-black/80 text-white text-xs px-4 py-2 rounded-full flex items-center gap-2\">\r\n                                <span class=\"w-2 h-2 bg-blue-400 rounded-full\"></span><span>Point camera at\r\n                                    student</span>\r\n                            </div>\r\n                        </div>\r\n                        <button type=\"button\" id=\"manual-capture-btn\" onclick=\"captureManualPhoto()\"\r\n                            class=\"w-full mt-2 py-3 rounded-xl font-display text-lg text-white tracking-wider bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 transition-all\">üì∑\r\n                            CAPTURE PHOTO</button>\r\n                    </div>\r\n\r\n                    <button type=\"submit\" id=\"manual-submit-btn\" disabled\r\n                        class=\"btn-primary w-full py-4 rounded-xl font-display text-lg text-white tracking-wider\">CAPTURE\r\n                        PHOTO FIRST</button>\r\n                </form>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== ALREADY CHECKED IN MODAL ==================== -->\r\n        <div id=\"already-in-modal\"\r\n            class=\"fixed inset-0 bg-black/95 backdrop-blur-md z-50 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-6 w-full max-w-sm text-center fade-in border-2 border-green-500/50\"\r\n                style=\"box-shadow: 0 0 60px rgba(34, 197, 94, 0.3);\">\r\n                <div class=\"w-20 h-20 mx-auto mb-4 rounded-full bg-green-500/20 flex items-center justify-center\">\r\n                    <svg class=\"w-10 h-10 text-green-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\" />\r\n                    </svg>\r\n                </div>\r\n                <h2 class=\"font-display text-2xl text-green-400 mb-2 tracking-wider\">YOU'RE ALREADY IN!</h2>\r\n                <p class=\"text-muted text-sm mb-4\">You've already checked in to this event</p>\r\n\r\n                <div class=\"bg-gray-900/50 rounded-xl p-4 mb-4 border border-green-500/30\">\r\n                    <p class=\"text-muted text-xs mb-1\">Event</p>\r\n                    <p class=\"font-display text-lg text-green-400\" id=\"already-in-event\">-</p>\r\n                    <p class=\"text-muted text-xs mt-3 mb-1\">Checked in at</p>\r\n                    <p class=\"font-display text-2xl text-white\" id=\"already-in-time\">-</p>\r\n                    <p class=\"text-muted text-xs mt-3 mb-1\">As</p>\r\n                    <p class=\"font-display text-sm text-cyan-400\" id=\"already-in-role\">Player</p>\r\n                </div>\r\n\r\n                <p class=\"text-white text-sm mb-1\" id=\"already-in-name\">-</p>\r\n                <p class=\"text-green-400/70 text-xs mb-4\">No need to scan again! ‚úì</p>\r\n\r\n                <div class=\"grid grid-cols-2 gap-3\">\r\n                    <button onclick=\"closeAlreadyInModal()\"\r\n                        class=\"py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-white font-semibold transition\">OK,\r\n                        GOT IT</button>\r\n                    <button onclick=\"proceedToCheckout()\"\r\n                        class=\"py-3 rounded-xl bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 font-semibold transition border border-purple-500/30\">CHECK\r\n                        OUT</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== PENDING CODE MODAL (Student) ==================== -->\r\n        <div id=\"pending-code-modal\"\r\n            class=\"fixed inset-0 bg-black/95 backdrop-blur-md z-50 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-6 w-full max-w-sm text-center fade-in border-2 border-yellow-500/50\"\r\n                style=\"box-shadow: 0 0 60px rgba(251, 191, 36, 0.3);\">\r\n                <!-- Animated waiting icon -->\r\n                <div class=\"relative w-20 h-20 mx-auto mb-4\">\r\n                    <div class=\"absolute inset-0 rounded-full bg-yellow-500/20 animate-ping\"></div>\r\n                    <div class=\"relative w-20 h-20 rounded-full bg-yellow-500/30 flex items-center justify-center\">\r\n                        <svg class=\"w-10 h-10 text-yellow-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\"\r\n                                d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                        </svg>\r\n                    </div>\r\n                </div>\r\n\r\n                <h2 class=\"font-display text-xl text-yellow-400 mb-2 tracking-wider\">WAITING FOR VERIFICATION</h2>\r\n                <p class=\"text-muted text-sm mb-4\" id=\"pending-status-text\">Show this code to the verifier</p>\r\n\r\n                <div class=\"bg-gray-900/50 rounded-2xl p-6 mb-4 border border-yellow-500/30\">\r\n                    <p class=\"text-muted text-xs mb-2\">Your Code</p>\r\n                    <p class=\"font-display text-5xl text-yellow-400 tracking-[0.2em]\" id=\"pending-code-display\">----</p>\r\n                </div>\r\n\r\n                <div class=\"text-left bg-gray-800/50 rounded-xl p-3 mb-4 space-y-1\">\r\n                    <p class=\"text-muted text-xs\">Name: <span class=\"text-white font-medium\"\r\n                            id=\"pending-student-name\">-</span></p>\r\n                    <p class=\"text-muted text-xs\">Event: <span class=\"text-white font-medium\"\r\n                            id=\"pending-event-name\">-</span></p>\r\n                    <p class=\"text-muted text-xs\">Scan Time: <span class=\"text-white font-medium\"\r\n                            id=\"pending-scan-time\">-</span></p>\r\n                </div>\r\n\r\n                <!-- Pulsing waiting indicator -->\r\n                <div class=\"flex items-center justify-center gap-2 mb-4\">\r\n                    <div class=\"loader-dots\">\r\n                        <span class=\"loader-dot\" style=\"background: #fbbf24;\"></span>\r\n                        <span class=\"loader-dot\" style=\"background: #fbbf24;\"></span>\r\n                        <span class=\"loader-dot\" style=\"background: #fbbf24;\"></span>\r\n                    </div>\r\n                </div>\r\n\r\n                <p class=\"text-yellow-400/70 text-xs\">Verifier will approve your attendance</p>\r\n                <p class=\"text-yellow-400/50 text-xs mt-1\">DO NOT close this screen</p>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== LEADERBOARD MODAL ==================== -->\r\n        <div id=\"leaderboard-modal\"\r\n            class=\"fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4\">\r\n            <div class=\"card p-5 w-full max-w-md max-h-[80vh] overflow-hidden fade-in\">\r\n                <div class=\"flex justify-between items-center mb-4\">\r\n                    <h2 class=\"font-display text-xl text-purple-400 tracking-wider\">üèÜ LEADERBOARD</h2>\r\n                    <button onclick=\"closeLeaderboard()\"\r\n                        class=\"w-8 h-8 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center text-white\">‚úï</button>\r\n                </div>\r\n                <div id=\"leaderboard-list\" class=\"space-y-2 overflow-y-auto max-h-96\">\r\n                    <p class=\"text-muted text-sm text-center py-4\">Loading...</p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- ==================== SUCCESS MODAL ==================== -->\r\n        <div id=\"success-modal\"\r\n            class=\"fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center\">\r\n            <div class=\"text-center fade-in\">\r\n                <div class=\"w-24 h-24 mx-auto mb-4 rounded-full bg-green-500/20 flex items-center justify-center\"\r\n                    style=\"box-shadow: 0 0 60px rgba(34, 197, 94, 0.5);\">\r\n                    <svg class=\"w-14 h-14 text-green-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"3\" d=\"M5 13l4 4L19 7\" />\r\n                    </svg>\r\n                </div>\r\n                <h2 class=\"font-display text-4xl text-white mb-2 tracking-wider\" id=\"success-title\">SUCCESS!</h2>\r\n                <p class=\"text-gray-300 text-lg\" id=\"success-message\">Done</p>\r\n            </div>\r\n        </div>\r\n\r\n    </div>" }} />
      <Script id="legacy-logic" strategy="lazyOnload" dangerouslySetInnerHTML={{ __html: "\nwindow.google = { script: { run: new Proxy({}, {\n  get: (target, prop) => (...args) => {\n    let s = null, f = null;\n    const chain = {\n       withSuccessHandler: h => { s = h; return chain; },\n       withFailureHandler: h => { f = h; return chain; }\n    };\n    if (prop === 'withSuccessHandler' || prop === 'withFailureHandler') return chain[prop](args[0]);\n    \n    console.log('[API PROXY] Calling API Route:', prop, args);\n    \n    fetch('/api/gas', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ func: prop, args })\n    })\n    .then(r => r.json())\n    .then(data => {\n      if (data.error) {\n        console.error('[API PROXY ERROR]', data.error);\n        if (f) f(new Error(data.error));\n      } else {\n        if (s) s(data.result);\n      }\n    })\n    .catch(err => {\n      console.error('[API PROXY NETWORK ERROR]', err);\n      if (f) f(err);\n    });\n  }\n})}};\n\n/**\r\n     * USC ATTENDANCE v5.2\r\n     * + Security hardening (XSS protection, input sanitization)\r\n     * + Memory leak fixes (proper interval cleanup)\r\n     * + Race condition fixes (scanner initialization)\r\n     * + Null safety checks throughout\r\n     * + Auto Lite Mode (for slow phones/network)\r\n     * + Fixed player/verifier session isolation\r\n     * + All Phase 2 features\r\n     */\r\n\r\n    // Strict mode for better error catching\r\n    'use strict';\r\n\r\n    const App = {\r\n        theme: 'dark',\r\n        liteMode: false,\r\n        permissions: { location: false, camera: false },\r\n        verifier: { sessionToken: null, regNo: null, name: null, eventName: null, locationName: '', gpsLat: 0, gpsLong: 0, stream: null, photoData: null, faceOk: false, isAdmin: false },\r\n        attendee: { regNo: null, name: null, role: 'Player', fingerprint: null, gpsLat: 0, gpsLong: 0, isLoggedIn: false, pendingCode: null, pendingScanTime: null },\r\n        scanner: null,\r\n        manualStream: null,\r\n        manualPhotoOk: false,\r\n        manualPhotoData: null,\r\n        intervals: { qr: null, stats: null, activity: null, face: null, pending: null, pendingStatus: null, volunteerStats: null },\r\n        faceApiReady: false,\r\n        faceLandmarksReady: false,\r\n        performanceScore: 100,\r\n        liveness: { blinkDetected: false, eyesClosed: false, blinkCount: 0, lastEAR: 1.0 }\r\n    };\r\n\r\n    // ==================== UI EXPERIENCE UTILITIES ====================\r\n\r\n    // Haptic Feedback (Vibration)\r\n    const Haptics = {\r\n        light: () => navigator.vibrate?.(30),\r\n        medium: () => navigator.vibrate?.(50),\r\n        heavy: () => navigator.vibrate?.(100),\r\n        success: () => navigator.vibrate?.([50, 50, 50]),\r\n        error: () => navigator.vibrate?.([100, 50, 100]),\r\n        warning: () => navigator.vibrate?.(80),\r\n        celebration: () => navigator.vibrate?.([50, 30, 50, 30, 100, 50, 150])\r\n    };\r\n\r\n    // Sound Effects\r\n    const Sounds = {\r\n        ctx: null,\r\n        init() {\r\n            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();\r\n        },\r\n        play(type) {\r\n            try {\r\n                this.init();\r\n                const osc = this.ctx.createOscillator();\r\n                const gain = this.ctx.createGain();\r\n                osc.connect(gain);\r\n                gain.connect(this.ctx.destination);\r\n                gain.gain.value = 0.1;\r\n\r\n                const now = this.ctx.currentTime;\r\n                switch (type) {\r\n                    case 'success':\r\n                        osc.frequency.setValueAtTime(523, now); // C5\r\n                        osc.frequency.setValueAtTime(659, now + 0.1); // E5\r\n                        osc.frequency.setValueAtTime(784, now + 0.2); // G5\r\n                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);\r\n                        osc.start(now);\r\n                        osc.stop(now + 0.4);\r\n                        break;\r\n                    case 'error':\r\n                        osc.frequency.setValueAtTime(200, now);\r\n                        osc.type = 'square';\r\n                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);\r\n                        osc.start(now);\r\n                        osc.stop(now + 0.3);\r\n                        break;\r\n                    case 'click':\r\n                        osc.frequency.setValueAtTime(800, now);\r\n                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);\r\n                        osc.start(now);\r\n                        osc.stop(now + 0.05);\r\n                        break;\r\n                    case 'scan':\r\n                        osc.frequency.setValueAtTime(880, now);\r\n                        osc.frequency.setValueAtTime(1100, now + 0.05);\r\n                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);\r\n                        osc.start(now);\r\n                        osc.stop(now + 0.15);\r\n                        break;\r\n                    case 'badge':\r\n                        osc.frequency.setValueAtTime(523, now);\r\n                        osc.frequency.setValueAtTime(659, now + 0.15);\r\n                        osc.frequency.setValueAtTime(784, now + 0.3);\r\n                        osc.frequency.setValueAtTime(1047, now + 0.45);\r\n                        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.8);\r\n                        osc.start(now);\r\n                        osc.stop(now + 0.8);\r\n                        break;\r\n                }\r\n            } catch (e) { }\r\n        }\r\n    };\r\n\r\n    // Confetti Animation\r\n    function confetti(duration = 3000) {\r\n        const container = document.createElement('div');\r\n        container.className = 'confetti-container';\r\n        container.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;overflow:hidden;';\r\n        document.body.appendChild(container);\r\n\r\n        const colors = ['#f97316', '#22d3ee', '#a855f7', '#22c55e', '#eab308', '#ec4899'];\r\n        const shapes = ['‚óè', '‚ñ†', '‚ñ≤', '‚òÖ', '‚ô¶'];\r\n\r\n        for (let i = 0; i < 80; i++) {\r\n            const piece = document.createElement('div');\r\n            piece.textContent = shapes[Math.floor(Math.random() * shapes.length)];\r\n            piece.style.cssText = `\r\n                position:absolute;\r\n                left:${Math.random() * 100}%;\r\n                top:-20px;\r\n                color:${colors[Math.floor(Math.random() * colors.length)]};\r\n                font-size:${12 + Math.random() * 16}px;\r\n                opacity:${0.7 + Math.random() * 0.3};\r\n                animation:confetti-fall ${2 + Math.random() * 2}s linear forwards;\r\n                animation-delay:${Math.random() * 0.5}s;\r\n            `;\r\n            container.appendChild(piece);\r\n        }\r\n\r\n        setTimeout(() => container.remove(), duration);\r\n    }\r\n\r\n    // Counter Animation\r\n    function animateCounter(element, target, duration = 800) {\r\n        if (!element) return;\r\n        const start = parseInt(element.textContent) || 0;\r\n        const startTime = performance.now();\r\n\r\n        function update(currentTime) {\r\n            const elapsed = currentTime - startTime;\r\n            const progress = Math.min(elapsed / duration, 1);\r\n            const eased = 1 - Math.pow(1 - progress, 3); // Ease out cubic\r\n            const current = Math.round(start + (target - start) * eased);\r\n            element.textContent = current;\r\n\r\n            if (progress < 1) requestAnimationFrame(update);\r\n        }\r\n        requestAnimationFrame(update);\r\n    }\r\n\r\n    // Input Shake Animation\r\n    function shakeElement(element) {\r\n        if (!element) return;\r\n        element.classList.add('shake-animation');\r\n        Haptics.error();\r\n        setTimeout(() => element.classList.remove('shake-animation'), 500);\r\n    }\r\n\r\n    // Glow Effect on Focus\r\n    function addGlowEffects() {\r\n        document.querySelectorAll('.input-field').forEach(input => {\r\n            input.addEventListener('focus', () => input.classList.add('input-glow'));\r\n            input.addEventListener('blur', () => input.classList.remove('input-glow'));\r\n        });\r\n    }\r\n\r\n\r\n    // Success Feedback (Sound + Haptic + Visual)\r\n    function successFeedback() {\r\n        Haptics.success();\r\n        Sounds.play('success');\r\n    }\r\n\r\n    // Error Feedback\r\n    function errorFeedback(inputEl) {\r\n        Haptics.error();\r\n        Sounds.play('error');\r\n        if (inputEl) shakeElement(inputEl);\r\n    }\r\n\r\n    // Celebration (Badge unlock, milestone)\r\n    function celebrate(message) {\r\n        confetti(3500);\r\n        Haptics.celebration();\r\n        Sounds.play('badge');\r\n        showMilestonePopup(message);\r\n    }\r\n\r\n    // Milestone Popup\r\n    function showMilestonePopup(message) {\r\n        const popup = document.createElement('div');\r\n        popup.className = 'milestone-popup';\r\n        popup.innerHTML = `<div class=\"milestone-content\"><span class=\"milestone-icon\">üéâ</span><p>${escapeHtml(message)}</p></div>`;\r\n        document.body.appendChild(popup);\r\n        setTimeout(() => popup.classList.add('show'), 50);\r\n        setTimeout(() => { popup.classList.remove('show'); setTimeout(() => popup.remove(), 400); }, 3000);\r\n    }\r\n\r\n    // ==================== INITIALIZATION ====================\r\n\r\n    document.addEventListener('DOMContentLoaded', async () => {\r\n        const startTime = performance.now();\r\n\r\n        await detectPerformance();\r\n        // Production: startup log removed\r\n\r\n        loadTheme();\r\n\r\n        try {\r\n            const fp = await FingerprintJS.load();\r\n            App.attendee.fingerprint = (await fp.get()).visitorId;\r\n        } catch (e) {\r\n            App.attendee.fingerprint = 'F_' + Date.now().toString(36) + Math.random().toString(36).slice(2);\r\n        }\r\n\r\n        loadFaceAPI();\r\n\r\n        document.getElementById('verifier-login-form').addEventListener('submit', handleVerifierLogin);\r\n        document.getElementById('attendee-login-form').addEventListener('submit', handleAttendeeLogin);\r\n        document.getElementById('manual-entry-form').addEventListener('submit', handleManualEntry);\r\n        document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);\r\n\r\n        ['ver-regno', 'att-regno', 'manual-regno', 'admin-id'].forEach(id => {\r\n            const el = document.getElementById(id);\r\n            if (el) el.addEventListener('input', e => {\r\n                e.target.value = e.target.value.replace(/\\D/g, '').slice(0, id === 'admin-id' ? 5 : 8);\r\n            });\r\n        });\r\n\r\n            const codeEl = document.getElementById('ver-code');\r\n            if (codeEl) {\r\n                codeEl.addEventListener('input', e => {\r\n                e.target.value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 6);\r\n        });\r\n        }\r\n\r\n        const loadTime = performance.now() - startTime;\r\n        if (loadTime > 3000 && !App.liteMode) {\r\n            localStorage.setItem('usc_lite_mode', 'true');\r\n        }\r\n\r\n        // Initialize UI enhancements\r\n        addGlowEffects();\r\n\r\n        // Add click sounds to all buttons\r\n        document.addEventListener('click', e => {\r\n            if (e.target.matches('button, .card[onclick], [data-action]')) {\r\n                Haptics.light();\r\n                Sounds.play('click');\r\n            }\r\n        });\r\n\r\n        // Initialize network status monitoring\r\n        initNetworkStatus();\r\n\r\n        checkPermissions();\r\n    });\r\n\r\n    // ==================== NETWORK STATUS MONITORING ====================\r\n\r\n    function initNetworkStatus() {\r\n        updateNetworkStatus();\r\n\r\n        // Listen for online/offline events\r\n        window.addEventListener('online', () => updateNetworkStatus());\r\n        window.addEventListener('offline', () => updateNetworkStatus());\r\n\r\n        // Check connection quality periodically\r\n        if (navigator.connection) {\r\n            navigator.connection.addEventListener('change', updateNetworkStatus);\r\n        }\r\n\r\n        // Periodic check every 10 seconds\r\n        setInterval(updateNetworkStatus, 10000);\r\n    }\r\n\r\n    function updateNetworkStatus() {\r\n        const indicator = document.getElementById('network-indicator');\r\n        const text = document.getElementById('network-text');\r\n        if (!indicator) return;\r\n\r\n        if (!navigator.onLine) {\r\n            indicator.className = 'w-2 h-2 rounded-full bg-red-500';\r\n            if (text) text.textContent = 'Offline';\r\n            showNetworkWarning('offline');\r\n            return;\r\n        }\r\n\r\n        const conn = navigator.connection;\r\n        if (conn) {\r\n            const type = conn.effectiveType;\r\n            const downlink = conn.downlink; // Mbps\r\n\r\n            if (type === 'slow-2g' || type === '2g' || downlink < 0.5) {\r\n                indicator.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';\r\n                if (text) text.textContent = 'Very Slow';\r\n                showNetworkWarning('slow');\r\n            } else if (type === '3g' || downlink < 1.5) {\r\n                indicator.className = 'w-2 h-2 rounded-full bg-yellow-500';\r\n                if (text) text.textContent = 'Slow';\r\n            } else {\r\n                indicator.className = 'w-2 h-2 rounded-full bg-green-500';\r\n                if (text) text.textContent = 'Good';\r\n                hideNetworkWarning();\r\n            }\r\n        } else {\r\n            // No connection API, assume online\r\n            indicator.className = 'w-2 h-2 rounded-full bg-green-500';\r\n            if (text) text.textContent = 'Online';\r\n        }\r\n    }\r\n\r\n    let networkWarningShown = false;\r\n    function showNetworkWarning(type) {\r\n        if (networkWarningShown) return;\r\n        networkWarningShown = true;\r\n\r\n        const message = type === 'offline'\r\n            ? 'üìµ You are offline. Some features may not work.'\r\n            : 'üì∂ Slow connection. Actions may take longer.';\r\n\r\n        toast(message, 'warning');\r\n        Haptics.warning();\r\n\r\n        // Reset after 30 seconds\r\n        setTimeout(() => { networkWarningShown = false; }, 30000);\r\n    }\r\n\r\n    function hideNetworkWarning() {\r\n        // Optional: could show \"back online\" message\r\n    }\r\n\r\n    function getNetworkStatus() {\r\n        if (!navigator.onLine) return 'offline';\r\n        const conn = navigator.connection;\r\n        if (!conn) return 'unknown';\r\n        if (conn.effectiveType === 'slow-2g' || conn.effectiveType === '2g') return 'very-slow';\r\n        if (conn.effectiveType === '3g') return 'slow';\r\n        return 'good';\r\n    }\r\n\r\n    // ==================== PERFORMANCE DETECTION ====================\r\n\r\n    async function detectPerformance() {\r\n        let score = 100;\r\n\r\n        if (localStorage.getItem('usc_lite_mode') === 'true') score -= 40;\r\n\r\n        if (navigator.connection) {\r\n            const conn = navigator.connection;\r\n            if (conn.effectiveType === '2g' || conn.effectiveType === 'slow-2g') score -= 50;\r\n            else if (conn.effectiveType === '3g') score -= 25;\r\n            if (conn.saveData) score -= 20;\r\n            if (conn.downlink && conn.downlink < 1) score -= 30;\r\n        }\r\n\r\n        if (navigator.deviceMemory && navigator.deviceMemory < 4) score -= 20;\r\n        if (navigator.hardwareConcurrency && navigator.hardwareConcurrency < 4) score -= 15;\r\n\r\n        const perfStart = performance.now();\r\n        let dummy = 0;\r\n        for (let i = 0; i < 100000; i++) dummy += Math.sqrt(i);\r\n        const perfTime = performance.now() - perfStart;\r\n        if (perfTime > 50) score -= 20;\r\n        if (perfTime > 100) score -= 20;\r\n\r\n        App.performanceScore = Math.max(0, score);\r\n        App.liteMode = score < 50;\r\n\r\n        if (App.liteMode) document.body.classList.add('lite-mode');\r\n    }\r\n\r\n    async function loadFaceAPI() {\r\n        try {\r\n            const timeout = App.liteMode ? 5000 : 10000;\r\n            const loadPromise = faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model');\r\n\r\n            await Promise.race([\r\n                loadPromise,\r\n                new Promise((_, reject) => setTimeout(() => reject('timeout'), timeout))\r\n            ]);\r\n\r\n            App.faceApiReady = true;\r\n            // Face API loaded\r\n        } catch (e) {\r\n            // Face API fallback mode\r\n            App.faceApiReady = false;\r\n        }\r\n    }\r\n\r\n    // ==================== LIVENESS DETECTION ====================\r\n\r\n    function calculateEAR(eye) {\r\n        const p1 = eye[0], p2 = eye[1], p3 = eye[2], p4 = eye[3], p5 = eye[4], p6 = eye[5];\r\n        const A = Math.sqrt(Math.pow(p2.x - p6.x, 2) + Math.pow(p2.y - p6.y, 2));\r\n        const B = Math.sqrt(Math.pow(p3.x - p5.x, 2) + Math.pow(p3.y - p5.y, 2));\r\n        const C = Math.sqrt(Math.pow(p1.x - p4.x, 2) + Math.pow(p1.y - p4.y, 2));\r\n        return (A + B) / (2.0 * C);\r\n    }\r\n\r\n    function detectBlink(landmarks) {\r\n        if (!landmarks) return false;\r\n        const leftEye = landmarks.getLeftEye();\r\n        const rightEye = landmarks.getRightEye();\r\n        const avgEAR = (calculateEAR(leftEye) + calculateEAR(rightEye)) / 2;\r\n\r\n        if (avgEAR < 0.21) {\r\n            if (!App.liveness.eyesClosed) App.liveness.eyesClosed = true;\r\n        } else {\r\n            if (App.liveness.eyesClosed) {\r\n                App.liveness.blinkCount++;\r\n                App.liveness.blinkDetected = true;\r\n            }\r\n            App.liveness.eyesClosed = false;\r\n        }\r\n        return App.liveness.blinkDetected;\r\n    }\r\n\r\n    function resetLivenessState() {\r\n        App.liveness = { blinkDetected: false, eyesClosed: false, blinkCount: 0, lastEAR: 1.0 };\r\n    }\r\n\r\n    // ==================== PERMISSIONS ====================\r\n\r\n    async function checkPermissions() {\r\n        if (navigator.permissions) {\r\n            try {\r\n                const locPerm = await navigator.permissions.query({ name: 'geolocation' });\r\n                updatePermissionUI('location', locPerm.state === 'granted' ? 'granted' : locPerm.state === 'denied' ? 'denied' : 'pending');\r\n                App.permissions.location = locPerm.state === 'granted';\r\n            } catch (e) { updatePermissionUI('location', 'pending'); }\r\n\r\n            try {\r\n                const camPerm = await navigator.permissions.query({ name: 'camera' });\r\n                updatePermissionUI('camera', camPerm.state === 'granted' ? 'granted' : camPerm.state === 'denied' ? 'denied' : 'pending');\r\n                App.permissions.camera = camPerm.state === 'granted';\r\n            } catch (e) { updatePermissionUI('camera', 'pending'); }\r\n        }\r\n\r\n        if (App.permissions.location && App.permissions.camera) proceedAfterPermissions();\r\n    }\r\n\r\n    function updatePermissionUI(type, state) {\r\n        const item = document.getElementById(`perm-${type}-item`);\r\n        const status = document.getElementById(`perm-${type}-status`);\r\n        const badge = document.getElementById(`perm-${type}-badge`);\r\n        const icon = document.getElementById(`perm-${type}-icon`);\r\n        if (!item) return;\r\n\r\n        item.className = `check-item ${state}`;\r\n        if (state === 'granted') {\r\n            status.textContent = 'Access granted';\r\n            badge.innerHTML = '<span class=\"text-green-500 text-xs font-semibold\">‚úì GRANTED</span>';\r\n            icon.className = 'w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center';\r\n            icon.innerHTML = '<svg class=\"w-5 h-5 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>';\r\n        } else if (state === 'denied') {\r\n            status.textContent = 'Access denied';\r\n            badge.innerHTML = '<span class=\"text-red-500 text-xs font-semibold\">‚úó DENIED</span>';\r\n        }\r\n\r\n        const mainIcon = document.getElementById('perm-main-icon');\r\n        if (mainIcon && App.permissions.location && App.permissions.camera) {\r\n            mainIcon.className = 'permission-icon granted';\r\n            mainIcon.innerHTML = '<svg class=\"w-10 h-10\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>';\r\n        }\r\n    }\r\n\r\n    async function requestPermissions() {\r\n        const btn = document.getElementById('perm-grant-btn');\r\n        btn.disabled = true;\r\n        btn.textContent = 'REQUESTING...';\r\n\r\n        try {\r\n            const position = await new Promise((resolve, reject) => {\r\n                navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 15000 });\r\n            });\r\n            App.permissions.location = true;\r\n            App.attendee.gpsLat = position.coords.latitude;\r\n            App.attendee.gpsLong = position.coords.longitude;\r\n            updatePermissionUI('location', 'granted');\r\n        } catch (e) {\r\n            updatePermissionUI('location', 'denied');\r\n            toast('Location access required!', 'error');\r\n            btn.disabled = false; btn.textContent = 'GRANT PERMISSIONS';\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({ video: true });\r\n            stream.getTracks().forEach(t => t.stop());\r\n            App.permissions.camera = true;\r\n            updatePermissionUI('camera', 'granted');\r\n        } catch (e) {\r\n            updatePermissionUI('camera', 'denied');\r\n            toast('Camera access required!', 'error');\r\n            btn.disabled = false; btn.textContent = 'GRANT PERMISSIONS';\r\n            return;\r\n        }\r\n\r\n        btn.textContent = 'PERMISSIONS GRANTED ‚úì';\r\n        toast('All permissions granted!', 'success');\r\n        setTimeout(() => proceedAfterPermissions(), 1000);\r\n    }\r\n\r\n    function proceedAfterPermissions() {\r\n        loadEvents();\r\n        checkSession();\r\n    }\r\n\r\n    // ==================== EVENTS ====================\r\n\r\n    function loadEvents() {\r\n        google.script.run.withSuccessHandler(events => {\r\n            // Verifier dropdown - needs event\r\n            const verSel = document.getElementById('ver-event');\r\n            if (verSel) {\r\n                verSel.innerHTML = events?.length\r\n                    ? '<option value=\"\">-- Select Event --</option>' + events.map(e => `<option value=\"${escapeHtmlAttr(e.name)}\">${escapeHtml(e.name)}${e.eventCode ? ' [' + escapeHtml(e.eventCode) + ']' : ''}</option>`).join('')\r\n                    : '<option value=\"\">No events</option>';\r\n            }\r\n\r\n            // Admin dropdown - event optional\r\n            const adminSel = document.getElementById('admin-event');\r\n            if (adminSel) {\r\n                let options = '<option value=\"__ADMIN_ONLY__\">-- Admin Dashboard Only --</option>';\r\n                if (events?.length) {\r\n                    options += events.map(e => `<option value=\"${escapeHtmlAttr(e.name)}\">${escapeHtml(e.name)}</option>`).join('');\r\n                }\r\n                adminSel.innerHTML = options;\r\n            }\r\n        }).withFailureHandler(() => {\r\n            ['ver-event', 'admin-event'].forEach(id => {\r\n                const sel = document.getElementById(id);\r\n                if (sel) sel.innerHTML = id === 'admin-event'\r\n                    ? '<option value=\"__ADMIN_ONLY__\">-- Admin Dashboard Only --</option>'\r\n                    : '<option value=\"\">Error loading</option>';\r\n            });\r\n        }).getActiveEvents();\r\n    }\r\n\r\n    // ==================== SESSION CHECK ====================\r\n\r\n    function checkSession() {\r\n        const saved = localStorage.getItem('usc_session');\r\n        if (!saved) { showScreen('role-select'); return; }\r\n\r\n        try {\r\n            const s = JSON.parse(saved);\r\n            if (s.isAdmin && s.sessionToken?.startsWith('ADMIN_')) {\r\n                google.script.run.withSuccessHandler(r => {\r\n                    if (r?.success) {\r\n                        const eventName = r.eventName === '__ADMIN_ONLY__' ? 'Admin Dashboard' : r.eventName;\r\n                        Object.assign(App.verifier, { sessionToken: s.sessionToken, regNo: s.regNo, name: s.name || 'Administrator', eventName: eventName, locationName: r.locationName || '', isAdmin: true });\r\n                        // If admin-only mode, go to admin dashboard\r\n                        if (r.eventName === '__ADMIN_ONLY__') {\r\n                            openAdminDashboard();\r\n                        } else {\r\n                            initDashboard();\r\n                        }\r\n                    } else { localStorage.removeItem('usc_session'); showScreen('role-select'); }\r\n                }).withFailureHandler(() => { localStorage.removeItem('usc_session'); showScreen('role-select'); }).getAdminSession(s.sessionToken);\r\n            } else if (s.sessionToken && !s.isPlayer) {\r\n                google.script.run.withSuccessHandler(r => {\r\n                    if (r?.success) {\r\n                        Object.assign(App.verifier, { sessionToken: s.sessionToken, regNo: s.regNo, name: r.name || s.name, eventName: r.eventName, locationName: r.locationName || '', isAdmin: false });\r\n                        initDashboard();\r\n                    } else { localStorage.removeItem('usc_session'); showScreen('role-select'); }\r\n                }).withFailureHandler(() => { localStorage.removeItem('usc_session'); showScreen('role-select'); }).getVolunteerSession(s.sessionToken);\r\n            } else {\r\n                localStorage.removeItem('usc_session');\r\n                showScreen('role-select');\r\n            }\r\n        } catch (e) { localStorage.removeItem('usc_session'); showScreen('role-select'); }\r\n    }\r\n\r\n    // ==================== THEME ====================\r\n\r\n    function toggleTheme() {\r\n        App.theme = App.theme === 'dark' ? 'light' : 'dark';\r\n        document.body.className = App.theme + ' min-h-screen text-main' + (App.liteMode ? ' lite-mode' : '');\r\n        document.getElementById('theme-toggle')?.classList.toggle('light', App.theme === 'light');\r\n        localStorage.setItem('usc_theme', App.theme);\r\n    }\r\n\r\n    function loadTheme() {\r\n        App.theme = localStorage.getItem('usc_theme') || 'dark';\r\n        document.body.className = App.theme + ' min-h-screen text-main' + (App.liteMode ? ' lite-mode' : '');\r\n        if (App.theme === 'light') document.getElementById('theme-toggle')?.classList.add('light');\r\n    }\r\n\r\n    // ==================== NAVIGATION ====================\r\n\r\n    function showScreen(name) {\r\n        if (name !== 'permission-check' && (!App.permissions.location || !App.permissions.camera)) return;\r\n        stopAll();\r\n        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));\r\n        const el = document.getElementById('screen-' + name);\r\n        if (el) { el.classList.remove('hidden'); initScreen(name); }\r\n    }\r\n\r\n    function initScreen(name) {\r\n        if (name === 'verifier-login') { loadEvents(); startVerifierCamera(); }\r\n        else if (name === 'admin-login') { loadEvents(); }\r\n        else if (name === 'attendee-scanner') { initScanner(); }\r\n    }\r\n\r\n    function stopAll() {\r\n        if (App.verifier.stream) { App.verifier.stream.getTracks().forEach(t => t.stop()); App.verifier.stream = null; }\r\n        if (App.manualStream) { App.manualStream.getTracks().forEach(t => t.stop()); App.manualStream = null; }\r\n        if (App.scanner) { try { App.scanner.stop(); } catch (e) { } App.scanner = null; }\r\n        Object.keys(App.intervals).forEach(k => { if (App.intervals[k]) { clearInterval(App.intervals[k]); App.intervals[k] = null; } });\r\n        App.verifier.faceOk = false;\r\n        App.manualPhotoOk = false;\r\n        resetLivenessState();\r\n    }\r\n\r\n    // FIX: Player back button - only affects player session, not verifier\r\n    function stopScannerAndGoBack() {\r\n        stopAll();\r\n        // Close pending modal if open\r\n        document.getElementById('pending-code-modal')?.classList.add('hidden');\r\n        App.attendee.isLoggedIn = false;\r\n        App.attendee.regNo = null;\r\n        App.attendee.name = null;\r\n        App.attendee.pendingCode = null;\r\n        App.attendee.pendingScanTime = null;\r\n        // Don't touch verifier session\r\n        showScreen('attendee-login');\r\n    }\r\n\r\n    // FIX: Player logout - clear only player data\r\n    function playerLogout() {\r\n        stopAll();\r\n        // Close pending modal if open\r\n        document.getElementById('pending-code-modal')?.classList.add('hidden');\r\n        App.attendee = { regNo: null, name: null, role: 'Player', fingerprint: null, gpsLat: 0, gpsLong: 0, isLoggedIn: false, pendingCode: null, pendingScanTime: null };\r\n        showScreen('role-select');\r\n        toast('Logged out', 'success');\r\n    }\r\n\r\n    // ==================== UI HELPERS ====================\r\n\r\n    function toast(msg, type = 'info') {\r\n        const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };\r\n        const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };\r\n        const t = document.createElement('div');\r\n        t.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-lg text-sm font-medium flex items-center gap-2 toast-enter`;\r\n        t.innerHTML = `<span class=\"text-lg\">${icons[type] || icons.info}</span><span>${escapeHtml(msg)}</span>`;\r\n        document.getElementById('toast-container')?.appendChild(t);\r\n\r\n        // Haptic and sound feedback\r\n        if (type === 'success') { Haptics.success(); Sounds.play('success'); }\r\n        else if (type === 'error') { Haptics.error(); Sounds.play('error'); }\r\n        else if (type === 'warning') { Haptics.warning(); }\r\n        else { Haptics.light(); }\r\n\r\n        setTimeout(() => { t.style.transition = 'all 0.3s'; t.style.opacity = '0'; t.style.transform = 'translateX(100%)'; setTimeout(() => t.remove(), 300); }, 4000);\r\n    }\r\n\r\n    function escapeHtml(text) {\r\n        const div = document.createElement('div');\r\n        div.textContent = text;\r\n        return div.innerHTML;\r\n    }\r\n\r\n    // Escape for safe use in HTML attributes (prevents XSS via onclick, etc.)\r\n    function escapeHtmlAttr(text) {\r\n        return String(text || '')\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#39;')\r\n            .replace(/`/g, '&#96;');\r\n    }\r\n\r\n    // Create a safe button with data attributes (avoids inline onclick XSS)\r\n    function safeBtn(classes, label, dataset) {\r\n        const attrs = Object.entries(dataset).map(([k, v]) => `data-${k}=\"${escapeHtmlAttr(v)}\"`).join(' ');\r\n        return `<button class=\"${classes}\" ${attrs}>${escapeHtml(label)}</button>`;\r\n    }\r\n\r\n    let loadingTimeout = null;\r\n    function showLoading(text = 'Processing...') {\r\n        const el = document.getElementById('loading-text');\r\n        if (el) el.textContent = text;\r\n        document.getElementById('loading-overlay')?.classList.remove('hidden');\r\n\r\n        // Auto-hide after 30 seconds to prevent infinite hang on network failure\r\n        clearTimeout(loadingTimeout);\r\n        loadingTimeout = setTimeout(() => {\r\n            hideLoading();\r\n            toast('Request timed out - please try again', 'error');\r\n        }, 30000);\r\n    }\r\n    function hideLoading() {\r\n        clearTimeout(loadingTimeout);\r\n        document.getElementById('loading-overlay')?.classList.add('hidden');\r\n    }\r\n\r\n    // PHASE3: Universal server error handler for withFailureHandler chains\r\n    // Cleans up loading overlay and shows user-friendly error toast\r\n    function handleServerError(err) {\r\n        hideLoading();\r\n        toast(err?.message || 'Server error ‚Äî please try again', 'error');\r\n    }\r\n    // PHASE3: Variant for admin dashboard panels ‚Äî hides loading + shows error in panel\r\n    function handlePanelError(panelId) {\r\n        return function(err) {\r\n            hideLoading();\r\n            var el = document.getElementById(panelId);\r\n            if (el) el.innerHTML = '<p class=\"text-red-400 text-center py-4\">Failed to load ‚Äî try refreshing</p>';\r\n        };\r\n    }\r\n\r\n    function showSuccess(title, msg) {\r\n        const titleEl = document.getElementById('success-title');\r\n        const msgEl = document.getElementById('success-message');\r\n        const modal = document.getElementById('success-modal');\r\n        if (titleEl) titleEl.textContent = title;\r\n        if (msgEl) msgEl.textContent = msg;\r\n        modal?.classList.remove('hidden');\r\n        setTimeout(() => modal?.classList.add('hidden'), 2500);\r\n    }\r\n\r\n    // ==================== VOLUNTEER PROFILE (PUBLIC) ====================\r\n\r\n    document.getElementById('profile-lookup-form')?.addEventListener('submit', handleProfileLookup);\r\n\r\n    function handleProfileLookup(e) {\r\n        e.preventDefault();\r\n        const regNo = document.getElementById('profile-regno').value.trim();\r\n\r\n        if (!/^\\d{8}$/.test(regNo)) { toast('Reg No: 8 digits required', 'error'); return; }\r\n\r\n        showLoading('Loading profile...');\r\n        App.profileRegNo = regNo; // Store for later use\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                displayProfile(r);\r\n                loadProfileHistory(regNo);\r\n                showScreen('volunteer-profile');\r\n            } else {\r\n                toast(r?.error || 'Profile not found', 'error');\r\n            }\r\n        }).withFailureHandler(err => {\r\n            hideLoading();\r\n            toast('Network error - try again', 'error');\r\n        }).getPublicVolunteerProfile(regNo);\r\n    }\r\n\r\n    function displayProfile(data) {\r\n        document.getElementById('profile-name').textContent = data.name || 'Unknown';\r\n        document.getElementById('profile-regno-display').textContent = data.regNo;\r\n        document.getElementById('profile-joined').textContent = data.joinedDate || '-';\r\n        document.getElementById('profile-hours').textContent = data.totalHours || 0;\r\n        document.getElementById('profile-events').textContent = data.totalEvents || 0;\r\n        document.getElementById('profile-days').textContent = data.totalDays || 0;\r\n        document.getElementById('profile-rank').textContent = '#' + (data.rank || '-');\r\n\r\n        // Badges\r\n        const badgesEl = document.getElementById('profile-badges');\r\n        if (badgesEl) {\r\n            if (data.badges?.length > 0) {\r\n                badgesEl.innerHTML = data.badges.map(b => `\r\n                    <div class=\"flex flex-col items-center p-2 rounded-lg bg-green-500/10 border border-green-500/30\">\r\n                        <span class=\"text-2xl\">${b.icon}</span>\r\n                        <span class=\"text-xs text-green-400 mt-1\">${escapeHtml(b.name)}</span>\r\n                    </div>\r\n                `).join('');\r\n            } else {\r\n                badgesEl.innerHTML = '<p class=\"text-muted text-sm\">Complete events to earn badges!</p>';\r\n            }\r\n        }\r\n    }\r\n\r\n    function loadProfileHistory(regNo) {\r\n        google.script.run.withSuccessHandler(r => {\r\n            const container = document.getElementById('profile-history');\r\n            if (!container) return;\r\n\r\n            if (r?.success && r.history?.length > 0) {\r\n                container.innerHTML = r.history.map(h => `\r\n                    <div class=\"flex justify-between items-center p-2 rounded-lg bg-gray-800/50 border border-gray-700\">\r\n                        <div>\r\n                            <p class=\"font-semibold text-sm\">${escapeHtml(h.event)}</p>\r\n                            <p class=\"text-muted text-xs\">${escapeHtml(h.date)} ‚Ä¢ ${escapeHtml(h.checkIn)} - ${escapeHtml(h.checkOut)}</p>\r\n                        </div>\r\n                        <div class=\"text-right\">\r\n                            <p class=\"font-display text-lg text-orange-400\">${h.hours}h</p>\r\n                            <p class=\"text-muted text-xs\">${h.studentsVerified} verified</p>\r\n                        </div>\r\n                    </div>\r\n                `).join('');\r\n            } else {\r\n                container.innerHTML = '<p class=\"text-muted text-sm text-center py-2\">No event history yet</p>';\r\n            }\r\n        }).withFailureHandler(handleServerError).getVolunteerHistory(regNo, 20);\r\n    }\r\n\r\n    function showPublicLeaderboard() {\r\n        const modal = document.getElementById('leaderboard-modal');\r\n        if (modal) modal.classList.remove('hidden');\r\n        loadPublicLeaderboard();\r\n    }\r\n\r\n    function loadPublicLeaderboard() {\r\n        google.script.run.withSuccessHandler(r => {\r\n            const container = document.getElementById('leaderboard-list');\r\n            if (!container) return;\r\n\r\n            if (r?.success && r.leaders?.length > 0) {\r\n                container.innerHTML = r.leaders.map((l, idx) => `\r\n                    <div class=\"flex items-center justify-between p-2 rounded-lg ${idx < 3 ? 'bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-500/30' : 'bg-gray-800/50'}\">\r\n                        <div class=\"flex items-center gap-3\">\r\n                            <span class=\"font-display text-lg ${idx === 0 ? 'text-yellow-400' : idx === 1 ? 'text-gray-300' : idx === 2 ? 'text-amber-600' : 'text-muted'}\">${getRankIcon(l.rank)}</span>\r\n                            <div>\r\n                                <p class=\"font-semibold text-sm\">${escapeHtml(l.name)}</p>\r\n                                <p class=\"text-muted text-xs\">${escapeHtml(String(l.totalEvents || 0))} events ‚Ä¢ ${escapeHtml(String(l.totalDays || 0))} days</p>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"text-right\">\r\n                            <p class=\"font-display text-lg text-orange-400\">${escapeHtml(String(l.totalHours || 0))}h</p>\r\n                            ${l.topBadge ? `<span class=\"text-sm\">${escapeHtml(l.topBadge)}</span>` : ''}\r\n                        </div>\r\n                    </div>\r\n                `).join('');\r\n            } else {\r\n                container.innerHTML = '<p class=\"text-muted text-sm text-center py-4\">No volunteers yet</p>';\r\n            }\r\n        }).withFailureHandler(function(){}).getPublicLeaderboard(15);\r\n    }\r\n\r\n    // ==================== ADMIN LOGIN ====================\r\n\r\n    async function handleAdminLogin(e) {\r\n        e.preventDefault();\r\n        const adminId = document.getElementById('admin-id').value.trim();\r\n        const password = document.getElementById('admin-password').value;\r\n        let event = document.getElementById('admin-event').value;\r\n        const location = document.getElementById('admin-location').value.trim();\r\n\r\n        if (!/^\\d{5}$/.test(adminId)) { toast('Admin ID: 5 digits', 'error'); return; }\r\n        if (!password) { toast('Password required', 'error'); return; }\r\n\r\n        // Handle admin-only mode (no event selected)\r\n        const isAdminOnly = !event || event === '__ADMIN_ONLY__';\r\n        if (isAdminOnly) event = '__ADMIN_ONLY__';\r\n\r\n        showLoading('Verifying Admin...');\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                const eventName = r.eventName === '__ADMIN_ONLY__' ? 'Admin Dashboard' : r.eventName;\r\n                App.verifier = { ...App.verifier, sessionToken: r.sessionToken, regNo: 'ADMIN_' + r.adminId, name: 'Administrator', eventName: eventName, locationName: r.locationName || location, isAdmin: true };\r\n                localStorage.setItem('usc_session', JSON.stringify({ sessionToken: r.sessionToken, regNo: 'ADMIN_' + r.adminId, name: 'Administrator', eventName: eventName, locationName: r.locationName || location, isAdmin: true, isPlayer: false }));\r\n                toast('Admin login successful!', 'success');\r\n\r\n                // If admin-only mode, go directly to admin dashboard\r\n                if (isAdminOnly || r.eventName === '__ADMIN_ONLY__') {\r\n                    openAdminDashboard();\r\n                } else {\r\n                    initDashboard();\r\n                }\r\n            } else toast(r?.error || 'Login failed', 'error');\r\n        }).withFailureHandler(err => { hideLoading(); toast(err?.message || 'Error', 'error'); }).adminLogin(adminId, password, App.attendee.fingerprint, event, location);\r\n    }\r\n\r\n    // ==================== VERIFIER LOGIN ====================\r\n\r\n    async function startVerifierCamera() {\r\n        const video = document.getElementById('ver-camera');\r\n        const oval = document.getElementById('ver-face-oval');\r\n        const status = document.getElementById('ver-face-status');\r\n        const capturedImg = document.getElementById('ver-captured-img');\r\n\r\n        App.verifier.faceOk = false;\r\n        App.verifier.photoData = null;\r\n\r\n        // Show video, hide captured image\r\n        if (video) video.style.display = 'block';\r\n        if (capturedImg) capturedImg.style.display = 'none';\r\n        oval?.classList.remove('detected');\r\n\r\n        try {\r\n            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 }, audio: false });\r\n            video.srcObject = stream;\r\n            App.verifier.stream = stream;\r\n\r\n            video.onloadedmetadata = () => {\r\n                status.innerHTML = '<span class=\"w-2 h-2 bg-yellow-500 rounded-full status-pulse\"></span><span>Looking for face...</span>';\r\n\r\n                // If Face API available, use face detection\r\n                if (App.faceApiReady) {\r\n                    App.intervals.face = setInterval(async () => {\r\n                        if (App.verifier.faceOk) return;\r\n                        try {\r\n                            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.5 }));\r\n\r\n                            if (detection) {\r\n                                // Face found! Capture immediately\r\n                                const photo = captureIfValid('ver-camera', 'ver-canvas');\r\n                                if (photo) {\r\n                                    clearInterval(App.intervals.face);\r\n                                    App.intervals.face = null;\r\n                                    App.verifier.photoData = photo;\r\n                                    App.verifier.faceOk = true;\r\n                                    oval?.classList.add('detected');\r\n                                    status.innerHTML = '<span class=\"w-2 h-2 bg-green-400 rounded-full\"></span><span>‚úì Photo captured!</span>';\r\n\r\n                                    // Stop camera and show captured image\r\n                                    if (App.verifier.stream) {\r\n                                        App.verifier.stream.getTracks().forEach(t => t.stop());\r\n                                        App.verifier.stream = null;\r\n                                    }\r\n                                    if (video) video.style.display = 'none';\r\n                                    if (capturedImg) {\r\n                                        capturedImg.src = photo;\r\n                                        capturedImg.style.display = 'block';\r\n                                    }\r\n                                    toast('Photo captured!', 'success');\r\n                                }\r\n                            } else {\r\n                                oval?.classList.remove('detected');\r\n                                status.innerHTML = '<span class=\"w-2 h-2 bg-yellow-500 rounded-full status-pulse\"></span><span>Position your face in oval</span>';\r\n                            }\r\n                        } catch (e) { }\r\n                    }, 300);\r\n                } else {\r\n                    // Fallback: 3-second timer if Face API not loaded\r\n                    status.innerHTML = '<span class=\"w-2 h-2 bg-blue-400 rounded-full status-pulse\"></span><span>Hold still 3 sec...</span>';\r\n                    let countdown = 3;\r\n                    const timer = setInterval(() => {\r\n                        countdown--;\r\n                        if (countdown > 0) {\r\n                            status.innerHTML = `<span class=\"w-2 h-2 bg-blue-400 rounded-full status-pulse\"></span><span>Hold still ${countdown}...</span>`;\r\n                        } else {\r\n                            clearInterval(timer);\r\n                            const photo = captureIfValid('ver-camera', 'ver-canvas');\r\n                            if (photo) {\r\n                                App.verifier.photoData = photo;\r\n                                App.verifier.faceOk = true;\r\n                                oval?.classList.add('detected');\r\n                                status.innerHTML = '<span class=\"w-2 h-2 bg-green-400 rounded-full\"></span><span>‚úì Photo captured!</span>';\r\n\r\n                                // Stop camera and show captured image\r\n                                if (App.verifier.stream) {\r\n                                    App.verifier.stream.getTracks().forEach(t => t.stop());\r\n                                    App.verifier.stream = null;\r\n                                }\r\n                                if (video) video.style.display = 'none';\r\n                                if (capturedImg) {\r\n                                    capturedImg.src = photo;\r\n                                    capturedImg.style.display = 'block';\r\n                                }\r\n                                toast('Photo captured!', 'success');\r\n                            } else {\r\n                                status.innerHTML = '<span class=\"w-2 h-2 bg-red-400 rounded-full\"></span><span>Try again - better lighting</span>';\r\n                            }\r\n                        }\r\n                    }, 1000);\r\n                }\r\n            };\r\n        } catch (e) { toast('Camera error', 'warning'); }\r\n    }\r\n\r\n    function captureIfValid(videoId, canvasId) {\r\n        const video = document.getElementById(videoId);\r\n        const canvas = document.getElementById(canvasId);\r\n        if (!video?.srcObject || video.videoWidth < 10) return null;\r\n\r\n        canvas.width = video.videoWidth;\r\n        canvas.height = video.videoHeight;\r\n        const ctx = canvas.getContext('2d');\r\n\r\n        if (video.classList.contains('webcam-mirror')) { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }\r\n        ctx.drawImage(video, 0, 0);\r\n\r\n        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\r\n        const data = imageData.data;\r\n        let brightness = 0;\r\n        const samples = Math.min(5000, data.length / 4);\r\n        const step = Math.floor(data.length / 4 / samples);\r\n        for (let i = 0; i < samples; i++) { const idx = i * step * 4; brightness += (data[idx] + data[idx + 1] + data[idx + 2]) / 3; }\r\n        brightness /= samples;\r\n        if (brightness < 15) return null;\r\n        return canvas.toDataURL('image/jpeg', 0.8);\r\n    }\r\n\r\n    async function getLocation() {\r\n        return new Promise(resolve => {\r\n            if (!navigator.geolocation) { resolve({ lat: 0, long: 0 }); return; }\r\n            navigator.geolocation.getCurrentPosition(\r\n                pos => resolve({ lat: pos.coords.latitude, long: pos.coords.longitude }),\r\n                () => resolve({ lat: App.attendee.gpsLat || 0, long: App.attendee.gpsLong || 0 }),\r\n                { enableHighAccuracy: true, timeout: 8000 }\r\n            );\r\n        });\r\n    }\r\n\r\n    function selectRole(el) {\r\n        document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));\r\n        el.classList.add('selected');\r\n        document.getElementById('att-role').value = el.dataset.role;\r\n        App.attendee.role = el.dataset.role;\r\n    }\r\n\r\n    async function handleVerifierLogin(e) {\r\n        e.preventDefault();\r\n        const regNo = document.getElementById('ver-regno').value.trim();\r\n        const name = document.getElementById('ver-name').value.trim();\r\n        const event = document.getElementById('ver-event').value;\r\n        const code = document.getElementById('ver-code').value.trim();\r\n        const location = document.getElementById('ver-location').value.trim();\r\n\r\n        if (!/^\\d{8}$/.test(regNo)) { toast('Reg No: 8 digits', 'error'); return; }\r\n        if (!/^[a-zA-Z0-9]{6}$/.test(code)) { toast('Code: 6 chars', 'error'); return; }\r\n        if (!event) { toast('Select event', 'error'); return; }\r\n\r\n        // Check if photo was captured\r\n        if (!App.verifier.photoData) {\r\n            toast('Wait for photo capture', 'error');\r\n            return;\r\n        }\r\n\r\n        showLoading('Verifying...');\r\n        const loc = await getLocation();\r\n        const photo = App.verifier.photoData;\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                App.verifier = { ...App.verifier, sessionToken: r.sessionToken, regNo, name, eventName: r.eventName, locationName: location, gpsLat: loc.lat, gpsLong: loc.long, isAdmin: false };\r\n                localStorage.setItem('usc_session', JSON.stringify({ sessionToken: r.sessionToken, regNo, name, eventName: r.eventName, locationName: location, isAdmin: false, isPlayer: false }));\r\n                toast('Login successful!', 'success');\r\n                initDashboard();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(err => { hideLoading(); toast(err?.message || 'Error', 'error'); }).volunteerLogin(regNo, name, code, loc.lat, loc.long, photo, event, location);\r\n    }\r\n\r\n    // ==================== DASHBOARD ====================\r\n\r\n    function initDashboard() {\r\n        stopAll();\r\n        const isAdmin = App.verifier.isAdmin;\r\n\r\n        document.getElementById('ver-dash-name').textContent = isAdmin ? 'Administrator' : (App.verifier.name || 'Verifier');\r\n        document.getElementById('ver-dash-event').textContent = App.verifier.eventName || 'Event';\r\n        document.getElementById('ver-dash-location').textContent = App.verifier.locationName || '';\r\n\r\n        const adminBadge = document.getElementById('admin-badge');\r\n        const eventCard = document.getElementById('event-card');\r\n        const eventTitle = document.getElementById('ver-dash-event');\r\n        const adminDashBtn = document.getElementById('open-admin-dash-btn');\r\n\r\n        if (isAdmin) {\r\n            adminBadge?.classList.remove('hidden');\r\n            adminDashBtn?.classList.remove('hidden');\r\n            if (eventCard) eventCard.style.borderColor = 'rgba(124, 58, 237, 0.5)';\r\n            if (eventTitle) eventTitle.className = 'font-display text-lg text-purple-500';\r\n            document.getElementById('end-shift-btn')?.classList.add('hidden');\r\n            document.getElementById('auto-attendance-badge')?.classList.add('hidden');\r\n        } else {\r\n            adminBadge?.classList.add('hidden');\r\n            adminDashBtn?.classList.add('hidden');\r\n            if (eventCard) eventCard.style.borderColor = 'rgba(255, 107, 0, 0.5)';\r\n            if (eventTitle) eventTitle.className = 'font-display text-lg text-orange-500';\r\n            // Show End Shift button and auto-attendance badge for volunteer/verifiers\r\n            document.getElementById('end-shift-btn')?.classList.remove('hidden');\r\n            document.getElementById('auto-attendance-badge')?.classList.remove('hidden');\r\n        }\r\n\r\n        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));\r\n        document.getElementById('screen-verifier-dashboard')?.classList.remove('hidden');\r\n\r\n        generateQR();\r\n        // Lite mode: slower refresh intervals for battery/performance\r\n        App.intervals.qr = setInterval(generateQR, App.liteMode ? 8000 : 5000);\r\n        refreshStats();\r\n        App.intervals.stats = setInterval(refreshStats, App.liteMode ? 15000 : 8000);\r\n        refreshPendingList();\r\n        App.intervals.pending = setInterval(refreshPendingList, App.liteMode ? 10000 : 5000);\r\n\r\n        // Load volunteer personal stats with LIVE refresh (not for admin)\r\n        if (!App.verifier.isAdmin) {\r\n            loadVolunteerStats();\r\n            // Live refresh every 30 seconds\r\n            App.intervals.volunteerStats = setInterval(loadVolunteerStats, App.liteMode ? 45000 : 30000);\r\n        }\r\n\r\n        App.intervals.activity = setInterval(() => {\r\n            if (App.verifier.isAdmin) google.script.run.withFailureHandler(function(){}).updateAdminActivity(App.verifier.sessionToken);\r\n            else google.script.run.withFailureHandler(function(){}).updateVolunteerActivity(App.verifier.sessionToken);\r\n        }, 60000);\r\n    }\r\n\r\n    function generateQR() {\r\n        // Get current GPS and send with QR request\r\n        getLocation().then(loc => {\r\n            google.script.run.withSuccessHandler(r => {\r\n                if (r?.success && r.qrData) {\r\n                    try {\r\n                        const qr = qrcode(0, 'M');\r\n                        qr.addData(r.qrData);\r\n                        qr.make();\r\n                        const qrDisplay = document.getElementById('qr-display');\r\n                        if (qrDisplay) qrDisplay.innerHTML = '<img src=\"' + qr.createDataURL(5, 4) + '\" style=\"width:200px;height:200px;image-rendering:pixelated;\">';\r\n                    } catch (e) { }\r\n                } else if (r?.error?.includes('expired') || r?.error?.includes('not found')) {\r\n                    verifierLogout();\r\n                }\r\n            }).withFailureHandler(function(){}).getNewQRData(App.verifier.sessionToken, loc.lat, loc.long);\r\n        });\r\n    }\r\n\r\n    function refreshStats() {\r\n        if (!App.verifier.eventName) return;\r\n        google.script.run.withSuccessHandler(r => {\r\n            if (r) {\r\n                const statIn = document.getElementById('stat-in');\r\n                const statTotal = document.getElementById('stat-total');\r\n                const statOut = document.getElementById('stat-out');\r\n                if (statIn) statIn.textContent = r.currentlyIn || 0;\r\n                if (statTotal) statTotal.textContent = r.totalIn || 0;\r\n                if (statOut) statOut.textContent = r.totalOut || 0;\r\n\r\n                const list = document.getElementById('students-list');\r\n                if (list) {\r\n                    if (r.students?.length) {\r\n                        list.innerHTML = r.students.map(s => `<div class=\"flex justify-between items-center p-2 rounded-lg hover:bg-orange-500/10\"><div><p class=\"font-semibold text-sm\">${escapeHtml(s.name)}</p><p class=\"text-muted text-xs\">${escapeHtml(s.regNo)} ‚Ä¢ ${escapeHtml(s.role)}</p></div><span class=\"text-green-400 text-xs font-display\">${escapeHtml(s.inTime)}</span></div>`).join('');\r\n                    } else list.innerHTML = '<p class=\"text-muted text-sm text-center py-4\">No one yet</p>';\r\n                }\r\n            }\r\n        }).withFailureHandler(function(){}).getEventStats(App.verifier.sessionToken, App.verifier.eventName);\r\n    }\r\n\r\n    // ==================== PENDING VERIFICATION ====================\r\n\r\n    function refreshPendingList() {\r\n        google.script.run.withSuccessHandler(r => {\r\n            const container = document.getElementById('pending-list');\r\n            const countEl = document.getElementById('pending-count');\r\n            const section = document.getElementById('pending-section');\r\n\r\n            if (!container) return;\r\n\r\n            if (r?.success && r.pending?.length > 0) {\r\n                section?.classList.remove('hidden');\r\n                if (countEl) countEl.textContent = r.pending.length;\r\n\r\n                container.innerHTML = r.pending.map(p => `\r\n        <div class=\"flex items-center justify-between p-2 rounded-lg bg-yellow-500/10 border border-yellow-500/30 mb-2\">\r\n          <div class=\"flex-1\">\r\n            <div class=\"flex items-center gap-2\">\r\n              <span class=\"font-display text-lg text-yellow-400\">${escapeHtml(p.code)}</span>\r\n              <span class=\"text-sm font-semibold\">${escapeHtml(p.name)}</span>\r\n            </div>\r\n            <p class=\"text-muted text-xs\">${escapeHtml(p.regNo)} ‚Ä¢ ${escapeHtml(p.scanTime)}</p>\r\n          </div>\r\n          <div class=\"flex gap-1\">\r\n            ${safeBtn('w-8 h-8 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 flex items-center justify-center', '‚úì', { action: 'approve', code: p.code })}\r\n            ${safeBtn('w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 flex items-center justify-center', '‚úï', { action: 'reject', code: p.code })}\r\n          </div>\r\n        </div>\r\n      `).join('');\r\n\r\n                // Show approve all button if more than 1\r\n                if (r.pending.length > 1) {\r\n                    container.innerHTML += `<button data-action=\"approve-all\" class=\"w-full py-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 text-sm font-semibold mt-2\">‚úì APPROVE ALL (${r.pending.length})</button>`;\r\n                }\r\n\r\n                // Setup event delegation for pending list actions\r\n                setupPendingListEvents();\r\n            } else {\r\n                section?.classList.add('hidden');\r\n                container.innerHTML = '';\r\n            }\r\n        }).withFailureHandler(function(){}).getPendingVerifications(App.verifier.sessionToken);\r\n    }\r\n\r\n    function setupPendingListEvents() {\r\n        const container = document.getElementById('pending-list');\r\n        if (!container || container.dataset.eventsSetup) return;\r\n        container.dataset.eventsSetup = 'true';\r\n\r\n        container.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            const action = btn.dataset.action;\r\n            const code = btn.dataset.code;\r\n\r\n            if (action === 'approve' && code) approveStudentCode(code);\r\n            else if (action === 'reject' && code) rejectStudentCode(code);\r\n            else if (action === 'approve-all') approveAllStudents();\r\n        });\r\n    }\r\n\r\n    function approveStudentCode(code) {\r\n        google.script.run.withSuccessHandler(r => {\r\n            if (r?.success) {\r\n                toast(`${r.name} - ${r.action}!`, 'success');\r\n                refreshPendingList();\r\n                refreshStats();\r\n            } else {\r\n                toast(r?.error || 'Failed', 'error');\r\n            }\r\n        }).withFailureHandler(handleServerError).approveStudent(App.verifier.sessionToken, code);\r\n    }\r\n\r\n    function rejectStudentCode(code) {\r\n        google.script.run.withSuccessHandler(r => {\r\n            if (r?.success) {\r\n                toast('Rejected', 'warning');\r\n                refreshPendingList();\r\n            } else {\r\n                toast(r?.error || 'Failed', 'error');\r\n            }\r\n        }).withFailureHandler(handleServerError).rejectStudent(App.verifier.sessionToken, code);\r\n    }\r\n\r\n    function approveAllStudents() {\r\n        showLoading('Approving all...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast(`Approved: ${r.approved}, Failed: ${r.failed}`, r.failed > 0 ? 'warning' : 'success');\r\n                refreshPendingList();\r\n                refreshStats();\r\n            } else {\r\n                toast(r?.error || 'Failed', 'error');\r\n            }\r\n        }).withFailureHandler(handleServerError).approveAllPending(App.verifier.sessionToken);\r\n    }\r\n\r\n    // END SHIFT - marks attendance OUT and fully logs out so verifier can re-login with new burn code\r\n    function endShift() {\r\n        if (!App.verifier.sessionToken || App.verifier.isAdmin) return;\r\n        \r\n        if (!confirm('End your shift?\\n\\nThis will:\\n‚Ä¢ Mark your attendance OUT for this event\\n‚Ä¢ Log you out\\n\\nYou can login again with a new burn code.')) return;\r\n        \r\n        showLoading('Ending shift...');\r\n        const token = App.verifier.sessionToken;\r\n        const eventName = App.verifier.eventName;\r\n        \r\n        localStorage.removeItem('usc_session');\r\n        App.verifier = { sessionToken: null, regNo: null, name: null, eventName: null, locationName: '', gpsLat: 0, gpsLong: 0, stream: null, photoData: null, faceOk: false, isAdmin: false };\r\n        \r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading(); stopAll();\r\n            toast(`Shift ended for ${eventName}. ${r?.studentsVerified || 0} students verified.`, 'success');\r\n            showScreen('verifier-login');\r\n            loadEvents();\r\n        }).withFailureHandler(() => {\r\n            hideLoading(); stopAll();\r\n            toast('Shift ended', 'success');\r\n            showScreen('verifier-login');\r\n            loadEvents();\r\n        }).volunteerLogout(token);\r\n    }\r\n\r\n    // FIX: Session isolation - check if user is actually a verifier/admin before logout\r\n    function verifierLogout() {\r\n        // Check if this is actually a verifier/admin session (not a player)\r\n        const savedSession = localStorage.getItem('usc_session');\r\n        if (savedSession) {\r\n            try {\r\n                const session = JSON.parse(savedSession);\r\n                if (session.isPlayer) {\r\n                    toast('You are logged in as Player, not Verifier', 'warning');\r\n                    showScreen('role-select');\r\n                    return;\r\n                }\r\n            } catch (e) { }\r\n        }\r\n\r\n        if (!App.verifier.sessionToken) {\r\n            toast('No active verifier session', 'warning');\r\n            showScreen('role-select');\r\n            return;\r\n        }\r\n\r\n        showLoading('Logging out...');\r\n        const logoutFn = App.verifier.isAdmin ? 'adminLogout' : 'volunteerLogout';\r\n        const token = App.verifier.sessionToken;\r\n\r\n        localStorage.removeItem('usc_session');\r\n        App.verifier = { sessionToken: null, regNo: null, name: null, eventName: null, locationName: '', gpsLat: 0, gpsLong: 0, stream: null, photoData: null, faceOk: false, isAdmin: false };\r\n\r\n        google.script.run.withSuccessHandler(() => { hideLoading(); stopAll(); showScreen('role-select'); toast('Logged out', 'success'); }).withFailureHandler(() => { hideLoading(); stopAll(); showScreen('role-select'); })[logoutFn](token);\r\n    }\r\n\r\n    // ==================== VOLUNTEER STATS ====================\r\n\r\n    function loadVolunteerStats() {\r\n        if (!App.verifier.sessionToken || App.verifier.isAdmin) return;\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            if (r?.success) {\r\n                updateVolunteerStatsUI(r);\r\n            }\r\n        }).withFailureHandler(function(){}).getVolunteerStats(App.verifier.sessionToken);\r\n    }\r\n\r\n    function updateVolunteerStatsUI(stats) {\r\n        const container = document.getElementById('volunteer-stats-container');\r\n        if (!container) return;\r\n\r\n        container.innerHTML = `\r\n            <div class=\"grid grid-cols-3 gap-2 mb-3\">\r\n                <div class=\"text-center p-2 rounded-lg bg-gradient-to-br from-orange-500/20 to-red-500/20 border border-orange-500/30\">\r\n                    <p class=\"font-display text-2xl text-orange-400\">${escapeHtml(String(stats.totalHours || 0))}</p>\r\n                    <p class=\"text-muted text-xs\">Hours</p>\r\n                </div>\r\n                <div class=\"text-center p-2 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30\">\r\n                    <p class=\"font-display text-2xl text-cyan-400\">${escapeHtml(String(stats.totalEvents || 0))}</p>\r\n                    <p class=\"text-muted text-xs\">Events</p>\r\n                </div>\r\n                <div class=\"text-center p-2 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30\">\r\n                    <p class=\"font-display text-2xl text-purple-400\">#${escapeHtml(String(stats.rank || '-'))}</p>\r\n                    <p class=\"text-muted text-xs\">Rank</p>\r\n                </div>\r\n            </div>\r\n            \r\n            ${stats.currentStreak > 0 ? `\r\n            <div class=\"flex items-center justify-center gap-2 mb-3 p-2 rounded-lg bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/30\">\r\n                <span class=\"text-2xl\">${getStreakEmoji(stats.currentStreak)}</span>\r\n                <div>\r\n                    <p class=\"font-display text-lg text-yellow-400\">${escapeHtml(String(stats.currentStreak))} Event Streak!</p>\r\n                    <p class=\"text-muted text-xs\">Best: ${escapeHtml(String(stats.longestStreak || 0))}</p>\r\n                </div>\r\n            </div>\r\n            ` : ''}\r\n            \r\n            ${stats.badges?.length > 0 ? `\r\n            <div class=\"flex flex-wrap gap-1 justify-center mb-2\">\r\n                ${stats.badges.map(b => `<span title=\"${escapeHtml(b.name)}: ${escapeHtml(b.desc)}\" class=\"text-xl cursor-help\">${b.icon}</span>`).join('')}\r\n            </div>\r\n            ` : '<p class=\"text-muted text-xs text-center mb-2\">Complete events to earn badges!</p>'}\r\n            \r\n            <button onclick=\"showLeaderboard()\" class=\"w-full py-2 rounded-lg bg-gradient-to-r from-purple-500/20 to-cyan-500/20 hover:from-purple-500/30 hover:to-cyan-500/30 text-white text-sm font-semibold transition border border-purple-500/30\">\r\n                üèÜ View Leaderboard\r\n            </button>\r\n        `;\r\n    }\r\n\r\n    function getStreakEmoji(streak) {\r\n        if (streak >= 20) return 'üíé';\r\n        if (streak >= 10) return 'üî•üî•üî•';\r\n        if (streak >= 5) return 'üî•üî•';\r\n        if (streak >= 3) return 'üî•';\r\n        return '‚ö°';\r\n    }\r\n\r\n    function showLeaderboard() {\r\n        const modal = document.getElementById('leaderboard-modal');\r\n        if (modal) modal.classList.remove('hidden');\r\n        loadLeaderboard();\r\n    }\r\n\r\n    function closeLeaderboard() {\r\n        document.getElementById('leaderboard-modal')?.classList.add('hidden');\r\n    }\r\n\r\n    function loadLeaderboard() {\r\n        google.script.run.withSuccessHandler(r => {\r\n            const container = document.getElementById('leaderboard-list');\r\n            if (!container) return;\r\n\r\n            if (r?.success && r.leaders?.length > 0) {\r\n                container.innerHTML = r.leaders.map((l, idx) => `\r\n                    <div class=\"flex items-center justify-between p-2 rounded-lg ${idx < 3 ? 'bg-gradient-to-r from-yellow-500/10 to-orange-500/10 border border-yellow-500/30' : 'bg-gray-800/50'}\">\r\n                        <div class=\"flex items-center gap-3\">\r\n                            <span class=\"font-display text-lg ${idx === 0 ? 'text-yellow-400' : idx === 1 ? 'text-gray-300' : idx === 2 ? 'text-amber-600' : 'text-muted'}\">${getRankIcon(l.rank)}</span>\r\n                            <div>\r\n                                <p class=\"font-semibold text-sm\">${escapeHtml(l.name?.split(' ')[0] || 'Unknown')} ${escapeHtml(l.name?.split(' ')[1]?.[0] || '')}.</p>\r\n                                <p class=\"text-muted text-xs\">${escapeHtml(String(l.totalEvents || 0))} events ‚Ä¢ ${l.currentStreak > 0 ? 'üî•' + escapeHtml(String(l.currentStreak)) : ''}</p>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"text-right\">\r\n                            <p class=\"font-display text-lg text-orange-400\">${escapeHtml(String(l.totalHours || 0))}h</p>\r\n                            ${l.topBadge ? `<span class=\"text-sm\">${escapeHtml(l.topBadge)}</span>` : ''}\r\n                        </div>\r\n                    </div>\r\n                `).join('');\r\n            } else {\r\n                container.innerHTML = '<p class=\"text-muted text-sm text-center py-4\">No volunteers yet</p>';\r\n            }\r\n        }).withFailureHandler(function(){}).getVolunteerLeaderboard(App.verifier.sessionToken, 'all', 10);\r\n    }\r\n\r\n    function getRankIcon(rank) {\r\n        if (rank === 1) return 'ü•á';\r\n        if (rank === 2) return 'ü•à';\r\n        if (rank === 3) return 'ü•â';\r\n        return '#' + rank;\r\n    }\r\n\r\n    // ==================== MANUAL ENTRY ====================\r\n\r\n    async function openManualEntry() {\r\n        document.getElementById('manual-entry-modal')?.classList.remove('hidden');\r\n        document.getElementById('manual-entry-form')?.reset();\r\n        App.manualPhotoData = null;\r\n\r\n        const isAdmin = App.verifier.isAdmin;\r\n        const cameraSection = document.getElementById('manual-camera-section');\r\n        const submitBtn = document.getElementById('manual-submit-btn');\r\n        const captureBtn = document.getElementById('manual-capture-btn');\r\n\r\n        if (isAdmin) {\r\n            if (cameraSection) cameraSection.style.display = 'none';\r\n            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'SUBMIT ENTRY'; }\r\n            App.manualPhotoOk = true;\r\n        } else {\r\n            if (cameraSection) cameraSection.style.display = 'block';\r\n            App.manualPhotoOk = false;\r\n            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'CAPTURE PHOTO FIRST'; }\r\n            if (captureBtn) { captureBtn.disabled = false; captureBtn.textContent = 'üì∑ CAPTURE PHOTO'; }\r\n\r\n            // Show video, hide captured image\r\n            const manualCamera = document.getElementById('manual-camera');\r\n            const capturedImg = document.getElementById('manual-captured-img');\r\n            if (manualCamera) manualCamera.style.display = 'block';\r\n            if (capturedImg) capturedImg.style.display = 'none';\r\n\r\n            try {\r\n                let stream;\r\n                // Try back camera first, fallback to any camera (for laptops)\r\n                try {\r\n                    stream = await navigator.mediaDevices.getUserMedia({\r\n                        video: { facingMode: { exact: 'environment' }, width: 640, height: 480 },\r\n                        audio: false\r\n                    });\r\n                } catch (e) {\r\n                    // Fallback to front/any camera (laptop)\r\n                    stream = await navigator.mediaDevices.getUserMedia({\r\n                        video: { width: 640, height: 480 },\r\n                        audio: false\r\n                    });\r\n                }\r\n\r\n                if (manualCamera) manualCamera.srcObject = stream;\r\n                App.manualStream = stream;\r\n\r\n                const status = document.getElementById('manual-face-status');\r\n                if (status) status.innerHTML = '<span class=\"w-2 h-2 bg-blue-400 rounded-full\"></span><span>Point camera at student, then tap Capture</span>';\r\n\r\n            } catch (e) {\r\n                toast('Camera access required!', 'error');\r\n                const status = document.getElementById('manual-face-status');\r\n                if (status) status.innerHTML = '<span class=\"w-2 h-2 bg-red-400 rounded-full\"></span><span>Camera not available</span>';\r\n            }\r\n        }\r\n    }\r\n\r\n    function captureManualPhoto() {\r\n        const captureBtn = document.getElementById('manual-capture-btn');\r\n        const submitBtn = document.getElementById('manual-submit-btn');\r\n        const status = document.getElementById('manual-face-status');\r\n        const oval = document.getElementById('manual-face-oval');\r\n        const manualCamera = document.getElementById('manual-camera');\r\n        const capturedImg = document.getElementById('manual-captured-img');\r\n\r\n        const photo = captureIfValid('manual-camera', 'manual-canvas');\r\n\r\n        if (photo) {\r\n            App.manualPhotoData = photo;\r\n            App.manualPhotoOk = true;\r\n\r\n            // Stop camera\r\n            if (App.manualStream) {\r\n                App.manualStream.getTracks().forEach(t => t.stop());\r\n                App.manualStream = null;\r\n            }\r\n\r\n            // Hide video, show captured image\r\n            if (manualCamera) manualCamera.style.display = 'none';\r\n            if (capturedImg) {\r\n                capturedImg.src = photo;\r\n                capturedImg.style.display = 'block';\r\n            }\r\n\r\n            oval?.classList.add('detected');\r\n            if (status) status.innerHTML = '<span class=\"w-2 h-2 bg-green-400 rounded-full\"></span><span>‚úì Photo captured!</span>';\r\n            if (captureBtn) { captureBtn.disabled = true; captureBtn.textContent = '‚úì CAPTURED'; }\r\n            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'SUBMIT ENTRY'; }\r\n            toast('Photo captured!', 'success');\r\n        } else {\r\n            toast('Failed - ensure good lighting', 'error');\r\n            if (status) status.innerHTML = '<span class=\"w-2 h-2 bg-red-400 rounded-full\"></span><span>Try again - better lighting needed</span>';\r\n        }\r\n    }\r\n\r\n    function closeManualEntry() {\r\n        document.getElementById('manual-entry-modal')?.classList.add('hidden');\r\n        if (App.manualStream) { App.manualStream.getTracks().forEach(t => t.stop()); App.manualStream = null; }\r\n        App.manualPhotoData = null;\r\n        App.manualPhotoOk = false;\r\n    }\r\n\r\n    async function handleManualEntry(e) {\r\n        e.preventDefault();\r\n        const regNo = document.getElementById('manual-regno').value.trim();\r\n        const name = document.getElementById('manual-name').value.trim();\r\n        const role = document.getElementById('manual-role').value;\r\n\r\n        if (!/^\\d{8}$/.test(regNo)) { toast('Reg No: 8 digits', 'error'); return; }\r\n\r\n        showLoading('Processing...');\r\n\r\n        if (App.verifier.isAdmin) {\r\n            google.script.run.withSuccessHandler(r => {\r\n                hideLoading();\r\n                if (r?.success) { closeManualEntry(); showSuccess(r.action === 'IN' ? 'CHECKED IN' : 'CHECKED OUT', r.message); refreshStats(); }\r\n                else toast(r?.error || 'Failed', 'error');\r\n            }).withFailureHandler(err => { hideLoading(); toast(err?.message || 'Error', 'error'); }).adminManualEntry(App.verifier.sessionToken, regNo, name, role, '');\r\n        } else {\r\n            // Use the captured photo\r\n            if (!App.manualPhotoData) { hideLoading(); toast('Capture photo first!', 'error'); return; }\r\n\r\n            google.script.run.withSuccessHandler(r => {\r\n                hideLoading();\r\n                if (r?.success) { closeManualEntry(); showSuccess(r.action === 'IN' ? 'CHECKED IN' : 'CHECKED OUT', r.message); refreshStats(); }\r\n                else toast(r?.error || 'Failed', 'error');\r\n            }).withFailureHandler(err => { hideLoading(); toast(err?.message || 'Error', 'error'); }).manualEntry(App.verifier.sessionToken, regNo, name, role, App.manualPhotoData, '');\r\n        }\r\n    }\r\n\r\n    // ==================== ATTENDEE/PLAYER ====================\r\n\r\n    async function handleAttendeeLogin(e) {\r\n        e.preventDefault();\r\n        const regNo = document.getElementById('att-regno').value.trim();\r\n        const name = document.getElementById('att-name').value.trim();\r\n        const role = document.getElementById('att-role').value;\r\n\r\n        if (!/^\\d{8}$/.test(regNo)) { toast('Reg No: 8 digits', 'error'); return; }\r\n        if (!name || name.length < 2) { toast('Name required (min 2 chars)', 'error'); return; }\r\n\r\n        App.attendee.regNo = regNo;\r\n        App.attendee.name = name;\r\n        App.attendee.role = role;\r\n        App.attendee.isLoggedIn = true;\r\n\r\n        showLoading('Checking status...');\r\n        const loc = await getLocation();\r\n        App.attendee.gpsLat = loc.lat;\r\n        App.attendee.gpsLong = loc.long;\r\n\r\n        // First check if student has pending verification\r\n        google.script.run.withSuccessHandler(pendingResult => {\r\n            if (pendingResult?.success && pendingResult.hasPending) {\r\n                hideLoading();\r\n                // Show waiting screen with existing code\r\n                showPendingWaitingScreen(pendingResult.code, pendingResult.scanTime, name, pendingResult.event);\r\n                return;\r\n            }\r\n\r\n            if (pendingResult?.success && pendingResult.status === 'Approved') {\r\n                hideLoading();\r\n                // Just approved! Show success\r\n                showSuccess(pendingResult.action === 'IN' ? 'CHECKED IN!' : 'CHECKED OUT!', `${pendingResult.action} at ${pendingResult.scanTime}`);\r\n                App.attendee.isLoggedIn = false;\r\n                setTimeout(() => showScreen('attendee-login'), 3000);\r\n                return;\r\n            }\r\n\r\n            if (pendingResult?.success && pendingResult.status === 'Rejected') {\r\n                hideLoading();\r\n                toast('Your verification was rejected. Please try again.', 'error');\r\n                App.attendee.isLoggedIn = false;\r\n                return;\r\n            }\r\n\r\n            // No pending - check normal status\r\n            google.script.run.withSuccessHandler(r => {\r\n                hideLoading();\r\n                if (r?.success) {\r\n                    if (r.status === 'IN') {\r\n                        // Check if role matches\r\n                        if (r.role && r.role !== role) {\r\n                            App.attendee.isLoggedIn = false;\r\n                            toast(`You checked in as ${r.role}, not ${role}!`, 'error');\r\n                            return;\r\n                        }\r\n                        App.attendee.role = r.role || role;\r\n                        showAlreadyInModal(r.event, r.entryTime, name, r.role);\r\n                    } else {\r\n                        // Not checked in - proceed to scanner\r\n                        const text = document.getElementById('att-status-text');\r\n                        if (text) {\r\n                            text.textContent = 'Ready to scan';\r\n                            text.className = 'font-display text-xl text-orange-500';\r\n                        }\r\n                        showScreen('attendee-scanner');\r\n                    }\r\n                } else {\r\n                    App.attendee.isLoggedIn = false;\r\n                    toast(r?.error || 'Error', 'error');\r\n                }\r\n            }).withFailureHandler(() => { hideLoading(); App.attendee.isLoggedIn = false; toast('Error', 'error'); }).withFailureHandler(handleServerError).getStudentStatus(regNo);\r\n\r\n        }).withFailureHandler(() => {\r\n            // If pending check fails, continue with normal flow\r\n            google.script.run.withSuccessHandler(r => {\r\n                hideLoading();\r\n                if (r?.success) {\r\n                    if (r.status === 'IN') {\r\n                        if (r.role && r.role !== role) {\r\n                            App.attendee.isLoggedIn = false;\r\n                            toast(`You checked in as ${r.role}, not ${role}!`, 'error');\r\n                            return;\r\n                        }\r\n                        App.attendee.role = r.role || role;\r\n                        showAlreadyInModal(r.event, r.entryTime, name, r.role);\r\n                    } else {\r\n                        const text = document.getElementById('att-status-text');\r\n                        if (text) {\r\n                            text.textContent = 'Ready to scan';\r\n                            text.className = 'font-display text-xl text-orange-500';\r\n                        }\r\n                        showScreen('attendee-scanner');\r\n                    }\r\n                } else {\r\n                    App.attendee.isLoggedIn = false;\r\n                    toast(r?.error || 'Error', 'error');\r\n                }\r\n            }).withFailureHandler(() => { hideLoading(); App.attendee.isLoggedIn = false; toast('Error', 'error'); }).getStudentStatus(regNo);\r\n        }).withFailureHandler(handleServerError).getStudentPendingStatus(regNo);\r\n    }\r\n\r\n    function showAlreadyInModal(event, entryTime, name, role) {\r\n        const modal = document.getElementById('already-in-modal');\r\n        if (modal) {\r\n            document.getElementById('already-in-event').textContent = event;\r\n            document.getElementById('already-in-time').textContent = entryTime;\r\n            document.getElementById('already-in-name').textContent = name;\r\n            document.getElementById('already-in-role').textContent = role || 'Player';\r\n            modal.classList.remove('hidden');\r\n        }\r\n    }\r\n\r\n    function closeAlreadyInModal() {\r\n        document.getElementById('already-in-modal')?.classList.add('hidden');\r\n    }\r\n\r\n    function proceedToCheckout() {\r\n        document.getElementById('already-in-modal')?.classList.add('hidden');\r\n        const text = document.getElementById('att-status-text');\r\n        if (text) {\r\n            text.textContent = 'Scan to CHECK OUT';\r\n            text.className = 'font-display text-xl text-purple-500';\r\n        }\r\n        showScreen('attendee-scanner');\r\n    }\r\n\r\n    // ==================== SCANNER ====================\r\n\r\n    async function initScanner() {\r\n        const attDashName = document.getElementById('att-dash-name');\r\n        const attDashRole = document.getElementById('att-dash-role');\r\n        if (attDashName) attDashName.textContent = App.attendee.name;\r\n        if (attDashRole) attDashRole.textContent = App.attendee.role;\r\n\r\n        const readerEl = document.getElementById('reader');\r\n        if (readerEl) readerEl.innerHTML = '<p class=\"text-center p-8 text-muted\">Starting camera...</p>';\r\n\r\n        await new Promise(r => setTimeout(r, 200));\r\n\r\n        try {\r\n            App.scanner = new Html5Qrcode('reader');\r\n            let cameraId = null;\r\n            try {\r\n                const devices = await Html5Qrcode.getCameras();\r\n                if (devices?.length) {\r\n                    const backCam = devices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear'));\r\n                    cameraId = backCam ? backCam.id : devices[devices.length - 1].id;\r\n                }\r\n            } catch (e) { }\r\n\r\n            // IMPROVED: Higher FPS (15-25) and larger scan area for faster detection\r\n            const config = {\r\n                fps: App.liteMode ? 15 : 25,  // Increased from 5/10\r\n                qrbox: { width: 280, height: 280 },  // Larger scan area\r\n                aspectRatio: 1,\r\n                disableFlip: false,\r\n                experimentalFeatures: {\r\n                    useBarCodeDetectorIfSupported: true  // Use native detector if available (faster)\r\n                }\r\n            };\r\n\r\n            if (cameraId) await App.scanner.start(cameraId, config, onScanSuccess, () => { });\r\n            else await App.scanner.start({ facingMode: 'environment' }, config, onScanSuccess, () => { });\r\n        } catch (e) {\r\n            console.error('Scanner error:', e);\r\n            if (readerEl) readerEl.innerHTML = `<div class=\"flex flex-col items-center justify-center h-full p-6 text-center\"><svg class=\"w-16 h-16 text-orange-500 mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\"/></svg><p class=\"font-semibold mb-2\">Camera Required</p><button onclick=\"initScanner()\" class=\"btn-primary px-6 py-2 rounded-xl text-white font-semibold\">Retry</button></div>`;\r\n        }\r\n    }\r\n\r\n    let scanning = false;\r\n    async function onScanSuccess(qrData) {\r\n        if (scanning) return;\r\n        scanning = true;\r\n        const attStatusText = document.getElementById('att-status-text');\r\n        if (attStatusText) attStatusText.textContent = 'Processing...';\r\n        if (App.scanner) { try { await App.scanner.pause(true); } catch (e) { } }\r\n        const loc = await getLocation();\r\n\r\n        google.script.run.withSuccessHandler(async r => {\r\n            if (r?.success) {\r\n                // Check if pending verification (GPS failed)\r\n                if (r.pending) {\r\n                    // Stop scanner and show pending code screen\r\n                    stopAll();\r\n                    showPendingCodeScreen(r.pendingCode, r.scanTime, App.attendee.name);\r\n                } else {\r\n                    // Normal success\r\n                    showSuccess(r.action === 'IN' ? 'CHECKED IN!' : 'CHECKED OUT!', r.message);\r\n                    setTimeout(() => { stopAll(); App.attendee.isLoggedIn = false; showScreen('attendee-login'); scanning = false; }, 2500);\r\n                }\r\n            } else {\r\n                toast(r?.error || 'Failed', 'error');\r\n                if (attStatusText) attStatusText.textContent = r?.error || 'Try again';\r\n                setTimeout(async () => { if (App.scanner) { try { await App.scanner.resume(); } catch (e) { } } if (attStatusText) attStatusText.textContent = 'Ready'; scanning = false; }, 2000);\r\n            }\r\n        }).withFailureHandler(async err => {\r\n            toast(err?.message || 'Error', 'error');\r\n            setTimeout(async () => { if (App.scanner) { try { await App.scanner.resume(); } catch (e) { } } scanning = false; }, 2000);\r\n        }).studentScan(qrData, App.attendee.regNo, App.attendee.name, loc.lat, loc.long, App.attendee.fingerprint, App.attendee.role, '');\r\n    }\r\n\r\n    function showPendingCodeScreen(code, scanTime, name) {\r\n        showPendingWaitingScreen(code, scanTime, name, App.verifier?.eventName || 'Event');\r\n    }\r\n\r\n    function showPendingWaitingScreen(code, scanTime, name, event) {\r\n        scanning = false;\r\n\r\n        // Stop scanner if active\r\n        if (App.scanner) {\r\n            try { App.scanner.stop(); } catch (e) { }\r\n            App.scanner = null;\r\n        }\r\n\r\n        // Store pending info\r\n        App.attendee.pendingCode = code;\r\n        App.attendee.pendingScanTime = scanTime;\r\n\r\n        // Show pending modal\r\n        const modal = document.getElementById('pending-code-modal');\r\n        if (modal) {\r\n            document.getElementById('pending-code-display').textContent = code;\r\n            document.getElementById('pending-student-name').textContent = name;\r\n            document.getElementById('pending-scan-time').textContent = scanTime;\r\n\r\n            // Update event name if element exists\r\n            const eventEl = document.getElementById('pending-event-name');\r\n            if (eventEl) eventEl.textContent = event;\r\n\r\n            // Update status text\r\n            const statusEl = document.getElementById('pending-status-text');\r\n            if (statusEl) statusEl.textContent = 'Show this code to the verifier';\r\n\r\n            modal.classList.remove('hidden');\r\n        }\r\n\r\n        // Hide other screens\r\n        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));\r\n\r\n        // Start polling for verification status\r\n        startPendingStatusPolling();\r\n    }\r\n\r\n    function startPendingStatusPolling() {\r\n        // Clear any existing polling\r\n        if (App.intervals.pendingStatus) {\r\n            clearInterval(App.intervals.pendingStatus);\r\n        }\r\n\r\n        // PHASE4: Safety limit ‚Äî stop polling after 5 minutes (100 polls √ó 3s)\r\n        var pollCount = 0;\r\n        var MAX_POLLS = 100;\r\n\r\n        // Poll every 3 seconds\r\n        App.intervals.pendingStatus = setInterval(() => {\r\n            if (!App.attendee.regNo || ++pollCount > MAX_POLLS) {\r\n                clearInterval(App.intervals.pendingStatus);\r\n                if (pollCount > MAX_POLLS) toast('Verification timed out ‚Äî please try scanning again', 'warning');\r\n                return;\r\n            }\r\n\r\n            google.script.run.withSuccessHandler(r => {\r\n                if (r?.success) {\r\n                    if (r.status === 'Approved') {\r\n                        // Approved! Show success\r\n                        clearInterval(App.intervals.pendingStatus);\r\n                        document.getElementById('pending-code-modal')?.classList.add('hidden');\r\n\r\n                        const action = r.action === 'IN' ? 'CHECKED IN!' : 'CHECKED OUT!';\r\n                        const message = `${r.action} at ${r.scanTime}`;\r\n                        showSuccess(action, message);\r\n\r\n                        App.attendee.isLoggedIn = false;\r\n                        App.attendee.pendingCode = null;\r\n\r\n                        setTimeout(() => showScreen('attendee-login'), 3000);\r\n\r\n                    } else if (r.status === 'Rejected') {\r\n                        // Rejected\r\n                        clearInterval(App.intervals.pendingStatus);\r\n                        document.getElementById('pending-code-modal')?.classList.add('hidden');\r\n\r\n                        toast('Verification rejected. Please try again.', 'error');\r\n                        App.attendee.isLoggedIn = false;\r\n                        App.attendee.pendingCode = null;\r\n\r\n                        showScreen('attendee-login');\r\n\r\n                    } else if (!r.hasPending) {\r\n                        // No longer pending (might have been processed)\r\n                        // Keep polling in case it was just approved\r\n                    }\r\n                    // If still pending, keep polling\r\n                }\r\n            }).withFailureHandler(function(){}).getStudentPendingStatus(App.attendee.regNo);\r\n        }, 3000);\r\n    }\r\n\r\n    function closePendingCodeModal() {\r\n        // Don't actually close - show warning\r\n        toast('Please wait for verifier to approve your code', 'warning');\r\n    }\r\n\r\n    // ==================== ADMIN DASHBOARD ====================\r\n\r\n    const AdminDash = {\r\n        currentTab: 'stats',\r\n        attPage: 1,\r\n        attPageSize: 20\r\n    };\r\n\r\n    function openAdminDashboard() {\r\n        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));\r\n        document.getElementById('screen-admin-dashboard')?.classList.remove('hidden');\r\n\r\n        const eventName = App.verifier.eventName;\r\n        document.getElementById('admin-dash-event').textContent = eventName === 'Admin Dashboard' ? 'All Events' : (eventName || 'All Events');\r\n\r\n        // Set default date to today\r\n        const today = new Date().toISOString().split('T')[0];\r\n        const dateFrom = document.getElementById('adm-date-from');\r\n        if (dateFrom) dateFrom.value = today;\r\n\r\n        switchAdminTab('stats');\r\n    }\r\n\r\n    function closeAdminDashboard() {\r\n        // If admin logged in with no event, logout and go to role select\r\n        if (App.verifier.eventName === 'Admin Dashboard' || !App.verifier.eventName) {\r\n            verifierLogout();\r\n        } else {\r\n            // Go back to QR dashboard\r\n            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));\r\n            document.getElementById('screen-verifier-dashboard')?.classList.remove('hidden');\r\n        }\r\n    }\r\n\r\n    function switchAdminTab(tab) {\r\n        AdminDash.currentTab = tab;\r\n\r\n        // Update tab UI\r\n        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));\r\n        document.querySelector(`.admin-tab[onclick=\"switchAdminTab('${tab}')\"]`)?.classList.add('active');\r\n\r\n        // Show panel\r\n        document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));\r\n        document.getElementById(`panel-${tab}`)?.classList.add('active');\r\n\r\n        // Load data\r\n        switch (tab) {\r\n            case 'stats': loadAdminStats(); break;\r\n            case 'attendance': loadAttendanceRecords(); break;\r\n            case 'events': loadAllEvents(); break;\r\n            case 'codes': loadBurnCodes(); break;\r\n            case 'blacklist': loadBlacklist(); break;\r\n            case 'activity': loadSuspiciousActivity(); break;\r\n            case 'verifiers': loadActiveVerifiers(); break;\r\n            case 'admins': loadAdminAccounts(); break;\r\n        }\r\n    }\r\n\r\n    // ========== STATS ==========\r\n    function loadAdminStats() {\r\n        const dateFrom = document.getElementById('adm-date-from')?.value || '';\r\n        const eventName = App.verifier.eventName === 'Admin Dashboard' ? 'all' : App.verifier.eventName;\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            if (r) {\r\n                document.getElementById('adm-stat-in').textContent = r.currentlyIn || 0;\r\n                document.getElementById('adm-stat-total').textContent = r.totalIn || 0;\r\n                document.getElementById('adm-stat-out').textContent = r.totalOut || 0;\r\n                document.getElementById('adm-stat-verifiers').textContent = r.activeVerifiers || 0;\r\n                document.getElementById('adm-role-players').textContent = r.roleBreakdown?.players || 0;\r\n                document.getElementById('adm-role-volunteers').textContent = r.roleBreakdown?.volunteers || 0;\r\n                document.getElementById('adm-role-others').textContent = r.roleBreakdown?.others || 0;\r\n            }\r\n        }).withFailureHandler(function(){}).getDashboardStats(App.verifier.sessionToken, eventName, dateFrom, dateFrom);\r\n    }\r\n\r\n    // ========== ATTENDANCE RECORDS ==========\r\n    function loadAttendanceRecords() {\r\n        const search = document.getElementById('adm-search')?.value || '';\r\n        const dateFrom = document.getElementById('adm-date-from')?.value || '';\r\n        const eventName = App.verifier.eventName === 'Admin Dashboard' ? 'all' : App.verifier.eventName;\r\n\r\n        google.script.run.withSuccessHandler(r => {\r\n            const tbody = document.getElementById('attendance-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (r?.records?.length) {\r\n                tbody.innerHTML = r.records.map(rec => `\r\n        <tr>\r\n          <td>${escapeHtml(rec.regNo)}</td>\r\n          <td>${escapeHtml((rec.name || '').substring(0, 12))}${(rec.name || '').length > 12 ? '...' : ''}</td>\r\n          <td>${escapeHtml(rec.timeIn)}</td>\r\n          <td>${escapeHtml(rec.timeOut || '-')}</td>\r\n          <td>\r\n            ${safeBtn('mini-btn mini-btn-orange', 'Edit', { action: 'edit-attendance', row: rec.rowIndex, regno: rec.regNo, name: rec.name || '', timein: rec.timeIn, timeout: rec.timeOut || '', flag: rec.flag || '' })}\r\n          </td>\r\n        </tr>\r\n      `).join('');\r\n                setupAttendanceTableEvents();\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-4\">No records found</td></tr>';\r\n            }\r\n\r\n            document.getElementById('att-page-info').textContent = `Page ${r?.page || 1} of ${r?.totalPages || 1} (${r?.total || 0} total)`;\r\n            AdminDash.attPage = r?.page || 1;\r\n        }).withFailureHandler(function(){}).getAttendanceRecords(App.verifier.sessionToken, eventName, dateFrom, dateFrom, search, AdminDash.attPage, AdminDash.attPageSize);\r\n    }\r\n\r\n    function setupAttendanceTableEvents() {\r\n        const tbody = document.getElementById('attendance-tbody');\r\n        if (!tbody || tbody.dataset.eventsSetup) return;\r\n        tbody.dataset.eventsSetup = 'true';\r\n\r\n        tbody.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            if (btn.dataset.action === 'edit-attendance') {\r\n                editAttendance(\r\n                    parseInt(btn.dataset.row),\r\n                    btn.dataset.regno,\r\n                    btn.dataset.name,\r\n                    btn.dataset.timein,\r\n                    btn.dataset.timeout,\r\n                    btn.dataset.flag\r\n                );\r\n            }\r\n        });\r\n    }\r\n\r\n    function searchAttendance() {\r\n        clearTimeout(AdminDash.searchTimeout);\r\n        AdminDash.searchTimeout = setTimeout(() => {\r\n            AdminDash.attPage = 1;\r\n            loadAttendanceRecords();\r\n        }, 300);\r\n    }\r\n\r\n    function prevAttPage() { if (AdminDash.attPage > 1) { AdminDash.attPage--; loadAttendanceRecords(); } }\r\n    function nextAttPage() { AdminDash.attPage++; loadAttendanceRecords(); }\r\n\r\n    function editAttendance(rowIndex, regNo, name, timeIn, timeOut, flag) {\r\n        document.getElementById('edit-row-index').value = rowIndex;\r\n        document.getElementById('edit-student-name').textContent = `${name} (${regNo})`;\r\n        document.getElementById('edit-time-in').value = timeIn || '';\r\n        document.getElementById('edit-time-out').value = timeOut || '';\r\n        document.getElementById('edit-flag').value = flag || '';\r\n        document.getElementById('edit-attendance-modal').classList.remove('hidden');\r\n    }\r\n\r\n    function saveAttendanceEdit() {\r\n        const rowIndex = parseInt(document.getElementById('edit-row-index').value);\r\n        const timeIn = document.getElementById('edit-time-in').value;\r\n        const timeOut = document.getElementById('edit-time-out').value;\r\n        const flag = document.getElementById('edit-flag').value;\r\n\r\n        showLoading('Saving...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast('Updated!', 'success');\r\n                document.getElementById('edit-attendance-modal').classList.add('hidden');\r\n                loadAttendanceRecords();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).updateAttendanceRecord(App.verifier.sessionToken, rowIndex, timeIn, timeOut, flag);\r\n    }\r\n\r\n    function deleteAttendanceEntry() {\r\n        if (!confirm('Delete this attendance record?')) return;\r\n        const rowIndex = parseInt(document.getElementById('edit-row-index').value);\r\n\r\n        showLoading('Deleting...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast('Deleted!', 'success');\r\n                document.getElementById('edit-attendance-modal').classList.add('hidden');\r\n                loadAttendanceRecords();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).deleteAttendanceRecord(App.verifier.sessionToken, rowIndex);\r\n    }\r\n\r\n    // ========== EVENTS ==========\r\n    function loadAllEvents() {\r\n        google.script.run.withSuccessHandler(events => {\r\n            const tbody = document.getElementById('events-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (events?.length) {\r\n                tbody.innerHTML = events.map(e => `\r\n        <tr>\r\n          <td>${escapeHtml((e.name || '').substring(0, 20))}${(e.name || '').length > 20 ? '...' : ''}</td>\r\n          <td class=\"text-xs font-mono text-orange-400\">${escapeHtml(e.eventCode || '-')}</td>\r\n          <td class=\"text-xs\">${escapeHtml(e.startDate || '')}${e.endDate !== e.startDate ? ' ‚Üí ' + escapeHtml(e.endDate || '') : ''}</td>\r\n          <td><span class=\"badge ${e.status === 'Active' ? 'badge-green' : 'badge-red'}\">${escapeHtml(e.status)}</span></td>\r\n          <td>\r\n            ${e.status === 'Active' ? safeBtn('mini-btn mini-btn-red', 'Close', { action: 'close-event', name: e.name }) : ''}\r\n          </td>\r\n        </tr>\r\n      `).join('');\r\n                setupEventsTableEvents();\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-4\">No events</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getAllEvents(App.verifier.sessionToken);\r\n    }\r\n\r\n    function setupEventsTableEvents() {\r\n        const tbody = document.getElementById('events-tbody');\r\n        if (!tbody || tbody.dataset.eventsSetup) return;\r\n        tbody.dataset.eventsSetup = 'true';\r\n\r\n        tbody.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            if (btn.dataset.action === 'close-event') {\r\n                closeEventAction(btn.dataset.name);\r\n            }\r\n        });\r\n    }\r\n\r\n    function showCreateEventModal() {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        document.getElementById('evt-name').value = '';\r\n        document.getElementById('evt-start-date').value = today;\r\n        document.getElementById('evt-end-date').value = today;\r\n        document.getElementById('evt-start-time').value = '09:00';\r\n        document.getElementById('evt-end-time').value = '18:00';\r\n        document.getElementById('evt-location').value = '';\r\n        document.getElementById('create-event-modal').classList.remove('hidden');\r\n    }\r\n\r\n    function createNewEvent() {\r\n        const name = document.getElementById('evt-name').value.trim();\r\n        const startDate = document.getElementById('evt-start-date').value;\r\n        const endDate = document.getElementById('evt-end-date').value;\r\n        const startTime = document.getElementById('evt-start-time').value;\r\n        const endTime = document.getElementById('evt-end-time').value;\r\n        const location = document.getElementById('evt-location').value.trim();\r\n\r\n        if (!name) { toast('Event name required', 'error'); return; }\r\n        if (!startDate || !endDate) { toast('Dates required', 'error'); return; }\r\n\r\n        showLoading('Creating event...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast(`Event created! Code: ${r.eventCode || 'N/A'}`, 'success');\r\n                document.getElementById('create-event-modal').classList.add('hidden');\r\n                loadAllEvents();\r\n                loadEvents(); // Refresh main event dropdown\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).createEvent(App.verifier.sessionToken, name, startDate, endDate, startTime, endTime, location);\r\n    }\r\n\r\n    function closeEventAction(eventName) {\r\n        if (!confirm(`Close event \"${eventName}\"?`)) return;\r\n        showLoading('Closing event...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) { toast('Event closed!', 'success'); loadAllEvents(); loadEvents(); }\r\n            else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).closeEvent(App.verifier.sessionToken, eventName);\r\n    }\r\n\r\n    // ========== BURN CODES ==========\r\n    function loadBurnCodes() {\r\n        const filter = document.getElementById('code-filter')?.value || 'all';\r\n        google.script.run.withSuccessHandler(codes => {\r\n            const tbody = document.getElementById('codes-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (codes?.length) {\r\n                tbody.innerHTML = codes.map(c => `\r\n        <tr>\r\n          <td class=\"font-display\">${escapeHtml(c.code)}</td>\r\n          <td><span class=\"badge ${c.status === 'Active' ? 'badge-green' : 'badge-yellow'}\">${escapeHtml(c.status)}</span></td>\r\n          <td class=\"text-xs\">${escapeHtml(c.usedBy || '-')}</td>\r\n          <td class=\"text-xs\">${escapeHtml(c.usedDate || '-')}</td>\r\n        </tr>\r\n      `).join('');\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center text-muted py-4\">No codes</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getBurnCodes(App.verifier.sessionToken, filter);\r\n    }\r\n\r\n    function generateNewCodes() {\r\n        showLoading('Generating codes...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast(`Generated ${r.codes?.length || 10} codes!`, 'success');\r\n                loadBurnCodes();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).generateAdminCodes(App.verifier.sessionToken, 10);\r\n    }\r\n\r\n    // ========== BLACKLIST ==========\r\n    function loadBlacklist() {\r\n        google.script.run.withSuccessHandler(list => {\r\n            const tbody = document.getElementById('blacklist-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (list?.length) {\r\n                tbody.innerHTML = list.map((b, i) => `\r\n        <tr>\r\n          <td><span class=\"badge badge-purple\">${escapeHtml(b.type)}</span></td>\r\n          <td class=\"text-xs\">${escapeHtml((b.value || '').substring(0, 15))}${(b.value || '').length > 15 ? '...' : ''}</td>\r\n          <td class=\"text-xs\">${escapeHtml(b.reason || '-')}</td>\r\n          <td>${safeBtn('mini-btn mini-btn-green', 'Remove', { action: 'remove-blacklist', type: b.type, value: b.value })}</td>\r\n        </tr>\r\n      `).join('');\r\n                setupBlacklistTableEvents();\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center text-muted py-4\">No blacklist entries</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getBlacklist(App.verifier.sessionToken);\r\n    }\r\n\r\n    function setupBlacklistTableEvents() {\r\n        const tbody = document.getElementById('blacklist-tbody');\r\n        if (!tbody || tbody.dataset.eventsSetup) return;\r\n        tbody.dataset.eventsSetup = 'true';\r\n\r\n        tbody.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            if (btn.dataset.action === 'remove-blacklist') {\r\n                removeBlacklistEntry(btn.dataset.type, btn.dataset.value);\r\n            }\r\n        });\r\n    }\r\n\r\n    function addBlacklistEntry() {\r\n        const type = document.getElementById('bl-type').value;\r\n        const value = document.getElementById('bl-value').value.trim();\r\n        const reason = document.getElementById('bl-reason').value.trim();\r\n\r\n        if (!value) { toast('Value required', 'error'); return; }\r\n\r\n        showLoading('Adding...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast('Added to blacklist!', 'success');\r\n                document.getElementById('bl-value').value = '';\r\n                document.getElementById('bl-reason').value = '';\r\n                loadBlacklist();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).addToBlacklist(App.verifier.sessionToken, type, value, reason);\r\n    }\r\n\r\n    function removeBlacklistEntry(type, value) {\r\n        if (!confirm(`Remove ${value} from blacklist?`)) return;\r\n        showLoading('Removing...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) { toast('Removed!', 'success'); loadBlacklist(); }\r\n            else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).removeFromBlacklist(App.verifier.sessionToken, type, value);\r\n    }\r\n\r\n    // ========== SUSPICIOUS ACTIVITY ==========\r\n    function loadSuspiciousActivity() {\r\n        google.script.run.withSuccessHandler(activities => {\r\n            const tbody = document.getElementById('activity-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (activities?.length) {\r\n                tbody.innerHTML = activities.map(a => `\r\n        <tr>\r\n          <td class=\"text-xs\">${escapeHtml(a.timestamp || '')}</td>\r\n          <td>${escapeHtml(a.regNo || '-')}</td>\r\n          <td><span class=\"badge badge-yellow\">${escapeHtml(a.type || '')}</span></td>\r\n          <td class=\"text-xs\">${escapeHtml((a.details || '').substring(0, 30))}${(a.details || '').length > 30 ? '...' : ''}</td>\r\n        </tr>\r\n      `).join('');\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"4\" class=\"text-center text-muted py-4\">No suspicious activity</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getSuspiciousActivities(App.verifier.sessionToken, 50);\r\n    }\r\n\r\n    // ========== ACTIVE VERIFIERS ==========\r\n    function loadActiveVerifiers() {\r\n        google.script.run.withSuccessHandler(verifiers => {\r\n            const tbody = document.getElementById('verifiers-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (verifiers?.length) {\r\n                tbody.innerHTML = verifiers.map(v => `\r\n        <tr>\r\n          <td>${escapeHtml(v.regNo)}</td>\r\n          <td>${escapeHtml((v.name || '').substring(0, 12))}${(v.name || '').length > 12 ? '...' : ''}</td>\r\n          <td class=\"text-xs\">${escapeHtml((v.event || '').substring(0, 15))}${(v.event || '').length > 15 ? '...' : ''}</td>\r\n          <td class=\"text-xs\">${escapeHtml(v.location || '-')}</td>\r\n          <td>${safeBtn('mini-btn mini-btn-red', 'Logout', { action: 'logout-verifier', regno: v.regNo })}</td>\r\n        </tr>\r\n      `).join('');\r\n                setupVerifiersTableEvents();\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"5\" class=\"text-center text-muted py-4\">No active verifiers</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getActiveVerifiers(App.verifier.sessionToken);\r\n    }\r\n\r\n    function setupVerifiersTableEvents() {\r\n        const tbody = document.getElementById('verifiers-tbody');\r\n        if (!tbody || tbody.dataset.eventsSetup) return;\r\n        tbody.dataset.eventsSetup = 'true';\r\n\r\n        tbody.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            if (btn.dataset.action === 'logout-verifier') {\r\n                forceLogoutVerifierAction(btn.dataset.regno);\r\n            }\r\n        });\r\n    }\r\n\r\n    function forceLogoutVerifierAction(regNo) {\r\n        if (!confirm(`Force logout verifier ${regNo}?`)) return;\r\n        showLoading('Logging out...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) { toast('Verifier logged out!', 'success'); loadActiveVerifiers(); }\r\n            else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).forceLogoutVerifier(App.verifier.sessionToken, regNo);\r\n    }\r\n\r\n    // ========== ADMIN ACCOUNTS ==========\r\n    function loadAdminAccounts() {\r\n        google.script.run.withSuccessHandler(admins => {\r\n            const tbody = document.getElementById('admins-tbody');\r\n            if (!tbody) return;\r\n\r\n            if (admins?.length) {\r\n                tbody.innerHTML = admins.map(a => `\r\n        <tr>\r\n          <td class=\"font-display\">${escapeHtml(a.adminId)}</td>\r\n          <td><span class=\"badge ${a.status === 'Active' ? 'badge-green' : 'badge-red'}\">${escapeHtml(a.status)}</span></td>\r\n          <td>\r\n            ${a.status === 'Active'\r\n                        ? safeBtn('mini-btn mini-btn-red', 'Disable', { action: 'toggle-admin', row: a.rowIndex, status: 'Disabled' })\r\n                        : safeBtn('mini-btn mini-btn-green', 'Enable', { action: 'toggle-admin', row: a.rowIndex, status: 'Active' })\r\n                    }\r\n          </td>\r\n        </tr>\r\n      `).join('');\r\n                setupAdminsTableEvents();\r\n            } else {\r\n                tbody.innerHTML = '<tr><td colspan=\"3\" class=\"text-center text-muted py-4\">No admin accounts</td></tr>';\r\n            }\r\n        }).withFailureHandler(function(){}).getAdminAccounts(App.verifier.sessionToken);\r\n    }\r\n\r\n    function setupAdminsTableEvents() {\r\n        const tbody = document.getElementById('admins-tbody');\r\n        if (!tbody || tbody.dataset.eventsSetup) return;\r\n        tbody.dataset.eventsSetup = 'true';\r\n\r\n        tbody.addEventListener('click', e => {\r\n            const btn = e.target.closest('[data-action]');\r\n            if (!btn) return;\r\n\r\n            if (btn.dataset.action === 'toggle-admin') {\r\n                toggleAdminStatus(parseInt(btn.dataset.row), btn.dataset.status);\r\n            }\r\n        });\r\n    }\r\n\r\n    function addNewAdmin() {\r\n        const adminId = document.getElementById('new-admin-id').value.trim();\r\n        const password = document.getElementById('new-admin-pass').value;\r\n\r\n        if (!/^\\d{5}$/.test(adminId)) { toast('Admin ID must be 5 digits', 'error'); return; }\r\n        if (!password || password.length < 6) { toast('Password must be 6+ characters', 'error'); return; }\r\n\r\n        showLoading('Adding admin...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) {\r\n                toast('Admin added!', 'success');\r\n                document.getElementById('new-admin-id').value = '';\r\n                document.getElementById('new-admin-pass').value = '';\r\n                loadAdminAccounts();\r\n            } else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).addAdminAccount(App.verifier.sessionToken, adminId, password);\r\n    }\r\n\r\n    function toggleAdminStatus(rowIndex, newStatus) {\r\n        showLoading('Updating...');\r\n        google.script.run.withSuccessHandler(r => {\r\n            hideLoading();\r\n            if (r?.success) { toast('Updated!', 'success'); loadAdminAccounts(); }\r\n            else toast(r?.error || 'Failed', 'error');\r\n        }).withFailureHandler(handleServerError).updateAdminAccount(App.verifier.sessionToken, rowIndex, newStatus);\r\n    }\r\n\r\n    // ========== EXPORT ==========\r\n    function exportAttendance() {\r\n        const dateFrom = document.getElementById('adm-date-from')?.value || '';\r\n        const eventName = App.verifier.eventName === 'Admin Dashboard' ? 'all' : App.verifier.eventName;\r\n        showLoading('Exporting...');\r\n\r\n        google.script.run.withSuccessHandler(csv => {\r\n            hideLoading();\r\n            if (csv) {\r\n                const blob = new Blob([csv], { type: 'text/csv' });\r\n                const url = URL.createObjectURL(blob);\r\n                const a = document.createElement('a');\r\n                a.href = url;\r\n                a.download = `attendance_${dateFrom || 'all'}.csv`;\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                document.body.removeChild(a);\r\n                URL.revokeObjectURL(url);\r\n                toast('Downloaded!', 'success');\r\n            } else toast('No data to export', 'warning');\r\n        }).withFailureHandler(handleServerError).exportAttendanceCSV(App.verifier.sessionToken, eventName, dateFrom, dateFrom);\r\n    }\r\n\r\n    function exportVolunteers() {\r\n        const dateFrom = document.getElementById('adm-date-from')?.value || '';\r\n        const eventName = App.verifier.eventName === 'Admin Dashboard' ? 'all' : App.verifier.eventName;\r\n        showLoading('Exporting volunteers...');\r\n\r\n        google.script.run.withSuccessHandler(csv => {\r\n            hideLoading();\r\n            if (csv) {\r\n                const blob = new Blob([csv], { type: 'text/csv' });\r\n                const url = URL.createObjectURL(blob);\r\n                const a = document.createElement('a');\r\n                a.href = url;\r\n                a.download = `volunteers_${eventName}_${dateFrom || 'all'}.csv`;\r\n                document.body.appendChild(a);\r\n                a.click();\r\n                document.body.removeChild(a);\r\n                URL.revokeObjectURL(url);\r\n                toast('Volunteer data downloaded!', 'success');\r\n            } else toast('No volunteer data to export', 'warning');\r\n        }).withFailureHandler(handleServerError).exportVolunteersCSV(App.verifier.sessionToken, eventName, dateFrom);\r\n    }" }} />
    </>
  );
}